---
title: "QSRR revisited. Hierarchical models"
author:
  - name: "Paweł Wiczling*"
    affiliations:
      - name: "Department of Biopharmaceutics and Pharmacodynamics, Medical University of Gdańsk, Gen. J. Hallera 107, 80-416 Gdańsk, Poland"
date: "`r format(Sys.Date())`"
format:
  html:
    theme: cosmo
    toc: true
    code-fold: true  
    code-tools: true
    fig-width: 7
    fig-height: 7
knitr:
  opts_chunk: 
    dev: "ragg_png"
---

```{r knitr, include=FALSE}
knitr::opts_chunk$set(cache=FALSE, message=FALSE, error=FALSE, warning=FALSE, comment=NA, out.width='95%')
```

# Introductions

...

# Setup
```{r setup, message=FALSE}
library(ggplot2)
library(gridExtra)
library(patchwork)
library(tidyr)
library(dplyr)
library(GGally)
library(reshape2)
library(pracma)
library(here)
library(magick)
library(reticulate)
library(kableExtra)
require(visNetwork, quietly = TRUE)
library(igraph)
library(ggraph)
#remotes::install_github("metrumresearchgroup/mrgmisc")
library(tidyverse)
library(patchwork)

set.seed(10271998) ## not required but assures repeatable results

source("helper-functions.R")
```

```{r settings}
data_deliv_dir = here::here("data","deliv")
data_derived_dir = here::here("data","derived")
if(!file.exists(data_deliv_dir)) dir.create(data_deliv_dir, recursive = T)
if(!file.exists(data_derived_dir)) dir.create(data_derived_dir, recursive = T)

figures_eda_dir <- here::here("deliv","figures", "eda")
tables_eda_dir <- here::here("deliv","tables", "eda")
if(!file.exists(figures_eda_dir)) dir.create(figures_eda_dir, recursive = T)
if(!file.exists(tables_eda_dir)) dir.create(tables_eda_dir, recursive = T)

model_dir <- here::here("model","stan")  
figures_dir <- here::here("deliv","figures", "stan")
tables_dir <- here::here("deliv","tables", "stan")
if(!file.exists(figures_dir)) dir.create(figures_dir, recursive = T)
if(!file.exists(model_dir)) dir.create(model_dir, recursive = T)
if(!file.exists(tables_dir)) dir.create(tables_dir, recursive = T)
```

# EDA

We used a publicly available [dataset](www.retentionprediction.org/hplc/database/) that comprises the measurements of RP-HPLC retention times collected for 1026 analytes. The retention times were measured under isocratic conditions on Eclipse Plus C18 (Agilent) stationary phase with 3.5 μm particles. The experiments were conducted using a mixture of two solvents: solvent A, which was made of 0.1% formic acid in water, and solvent B, which was made of 0.1% formic acid in acetonitrile. The column temperature was set at 35\^{\circ}C. The data were collected by Boswell et al. and were used to create a method to predict retention time by Back-Calculating the Gradient.

## Load data
```{r load-data, message=FALSE, warning=FALSE}
data <- read.csv(here(data_deliv_dir, "database_logk_1026.csv"), header = TRUE)
analytes_names  <- read.csv(here(data_deliv_dir,"database_logk_1026_analyte_names.csv"), header = TRUE)
smiles <- read.csv(here(data_deliv_dir,"smiles1026.smi"), sep = "\t", header = FALSE)
functional_groups = read.csv(here(data_deliv_dir, 'checkmol_functional_groups.csv'))
functional_groups_names = read.csv(here(data_deliv_dir,'checkmol_functional_group_names.csv'))
data_ACD = read.csv(here(data_deliv_dir,'ACD_pKas.csv'))
data_pH <- read.csv(here(data_deliv_dir,"pH.csv"),header = TRUE)
results <-read.csv(here(data_deliv_dir,"results_table_max_frag_size.csv"))
comparison_table = read.csv(file = here(data_deliv_dir,"comparison_table.csv"), header = TRUE)
smiles<-smiles %>% rename(ID=V2,smiles=V1) %>% select(ID,smiles)
smiles$smiles[905] = "CN(C1CCCCC1N1CCCC1)C(=O)Cc1ccc(c(c1)Cl)Cl" # remove tartrate moiety 
smiles$smiles[425] = "CC(Cc1ccc(cc1)OCC(=O)O)NCC(c1cccc(c1)Cl)O" # remove Na+ and dissociation

analytes_names$Analyte <- iconv(analytes_names$Analyte, from = "", to = "UTF-8", sub = "byte")
```

# Python
```{r load-conda-environment}
# use_condaenv("rdkit-env", conda = "C:/Users/GUMed/anaconda3/Scripts/conda.exe", required = TRUE)
#.Renviron
```

```{r imoprt-modules}
Chem <- import("rdkit.Chem")
AllChem <- import("rdkit.Chem.AllChem")
Draw <- import("rdkit.Chem.Draw")
rdFMCS <- import("rdkit.Chem.rdFMCS")
rdmolops <- import("rdkit.Chem.rdmolops")
FunctionalGroups <- Chem$FunctionalGroups

# Create MCS parameters
mcs_params <- rdFMCS$MCSParameters()
mcs_params$AtomCompareParameters$MatchValences <- TRUE
mcs_params$AtomCompareParameters$RingMatchesRingOnly <- TRUE
mcs_params$AtomCompareParameters$CompleteRingsOnly <- TRUE
mcs_params$AtomCompare <- rdFMCS$AtomCompare$CompareElements
mcs_params$BondCompare <- rdFMCS$BondCompare$CompareOrderExact
mcs_params$BondCompareParameters$CompleteRingsOnly <- TRUE
mcs_params$BondCompareParameters$RingMatchesRingOnly <- TRUE
mcs_params$Timeout <- 20L
mcs_params$Verbose <- FALSE
mcs_params$Threshold <- 1.0
mcs_params$MaximizeBonds<-TRUE

custom_groups <- list(
  list(name = "Primary_carbon", smarts = "[CX4H3][#6]"),
  list(name = "Secondary_carbon", smarts = "[CX4H2]([#6])[#6]"),
  list(name = "Tertiary_carbon", smarts = "[CX4H1]([#6])([#6])[#6]"),
  list(name = "Quaternary_carbon", smarts = "[CX4]([#6])([#6])([#6])[#6]"),
  list(name = "Alkene", smarts = "[CX3;$([H2]),$([H1][#6]),$(C([#6])[#6])]=[CX3;$([H2]),$([H1][#6]),$(C([#6])[#6])]"),
  list(name = "Alkyne", smarts = "[CX2]#[CX2]"),
  list(name = "Allene", smarts = "[CX3]=[CX2]=[CX3]"),
  list(name = "Alkylchloride", smarts = "[ClX1][CX4]"),
  list(name = "Alkylfluoride", smarts = "[FX1][CX4]"),
  list(name = "Alkylbromide", smarts = "[BrX1][CX4]"),
  list(name = "Alkyliodide", smarts = "[IX1][CX4]"),
  list(name = "Alcohol", smarts = "[OX2H][CX4;!$(C([OX2H])[O,S,#7,#15])]"),
  list(name = "Primary_alcohol", smarts = "[OX2H][CX4H2;!$(C([OX2H])[O,S,#7,#15])]"),
  list(name = "Secondary_alcohol", smarts = "[OX2H][CX4H;!$(C([OX2H])[O,S,#7,#15])]"),
  list(name = "Tertiary_alcohol", smarts = "[OX2H][CX4D4;!$(C([OX2H])[O,S,#7,#15])]"),
  list(name = "Dialkylether", smarts = "[OX2]([CX4;!$(C([OX2])[O,S,#7,#15,F,Cl,Br,I])])[CX4;!$(C([OX2])[O,S,#7,#15])]"),
  list(name = "Dialkylthioether", smarts = "[SX2]([CX4;!$(C([OX2])[O,S,#7,#15,F,Cl,Br,I])])[CX4;!$(C([OX2])[O,S,#7,#15])]"),
  list(name = "Alkylarylether", smarts = "[OX2](c)[CX4;!$(C([OX2])[O,S,#7,#15,F,Cl,Br,I])]"),
  list(name = "Diarylether", smarts = "[c][OX2][c]"),
  list(name = "Alkylarylthioether", smarts = "[SX2](c)[CX4;!$(C([OX2])[O,S,#7,#15,F,Cl,Br,I])]"),
  list(name = "Diarylthioether", smarts = "[c][SX2][c]"),
  list(name = "Oxonium", smarts = "[O+;!$([O]~[!#6]);!$([S]*~[#7,#8,#15,#16])]"),
  list(name = "Amine", smarts = "[NX3+0,NX4+;!$([N]~[!#6]);!$([N]*~[#7,#8,#15,#16])]"),
  list(name = "Primary_aliph_amine", smarts = "[NX3H2+0,NX4H3+;!$([N][!C]);!$([N]*~[#7,#8,#15,#16])]"),
  list(name = "Secondary_aliph_amine", smarts = "[NX3H1+0,NX4H2+;!$([N][!C]);!$([N]*~[#7,#8,#15,#16])]"),
  list(name = "Tertiary_aliph_amine", smarts = "[NX3H0+0,NX4H1+;!$([N][!C]);!$([N]*~[#7,#8,#15,#16])]"),
  list(name = "Quaternary_aliph_ammonium", smarts = "[NX4H0+;!$([N][!C]);!$([N]*~[#7,#8,#15,#16])]"),
  list(name = "Primary_arom_amine", smarts = "[NX3H2+0,NX4H3+]c"),
  list(name = "Secondary_arom_amine", smarts = "[NX3H1+0,NX4H2+;!$([N][!c]);!$([N]*~[#7,#8,#15,#16])]"),
  list(name = "Tertiary_arom_amine", smarts = "[NX3H0+0,NX4H1+;!$([N][!c]);!$([N]*~[#7,#8,#15,#16])]"),
  list(name = "Quaternary_arom_ammonium", smarts = "[NX4H0+;!$([N][!c]);!$([N]*~[#7,#8,#15,#16])]"),
  list(name = "Secondary_mixed_amine", smarts = "[NX3H1+0,NX4H2+;$([N]([c])[C]);!$([N]*~[#7,#8,#15,#16])]"),
  list(name = "Tertiary_mixed_amine", smarts = "[NX3H0+0,NX4H1+;$([N]([c])([C])[#6]);!$([N]*~[#7,#8,#15,#16])]"),
  list(name = "Quaternary_mixed_ammonium", smarts = "[NX4H0+;$([N]([c])([C])[#6][#6]);!$([N]*~[#7,#8,#15,#16])]"),
  list(name = "Ammonium", smarts = "[N+;!$([N]~[!#6]);!$(N=*);!$([N]*~[#7,#8,#15,#16])]"),
  list(name = "Alkylthiol", smarts = "[SX2H][CX4;!$(C([SX2H])~[O,S,#7,#15])]"),
  list(name = "Dialkylthioether", smarts = "[SX2]([CX4;!$(C([SX2])[O,S,#7,#15,F,Cl,Br,I])])[CX4;!$(C([SX2])[O,S,#7,#15])]"),
  list(name = "Alkylarylthioether", smarts = "[SX2](c)[CX4;!$(C([SX2])[O,S,#7,#15])]"),
  list(name = "Disulfide", smarts = "[SX2D2][SX2D2]"),
  list(name = "1,2-Aminoalcohol", smarts = "[OX2H][CX4;!$(C([OX2H])[O,S,#7,#15,F,Cl,Br,I])][CX4;!$(C([N])[O,S,#7,#15])][NX3;!$(NC=[O,S,N])]"),
  list(name = "1,2-Diol", smarts = "[OX2H][CX4;!$(C([OX2H])[O,S,#7,#15])][CX4;!$(C([OX2H])[O,S,#7,#15])][OX2H]"),
  list(name = "1,1-Diol", smarts = "[OX2H][CX4;!$(C([OX2H])([OX2H])[O,S,#7,#15])][OX2H]"),
  list(name = "Hydroperoxide", smarts = "[OX2H][OX2]"),
  list(name = "Peroxo", smarts = "[OX2D2][OX2D2]"),
  list(name = "Organolithium_compounds", smarts = "[LiX1][#6,#14]"),
  list(name = "Organomagnesium_compounds", smarts = "[MgX2][#6,#14]"),
  list(name = "Organometallic_compounds", smarts = "[!#1;!#5;!#6;!#7;!#8;!#9;!#14;!#15;!#16;!#17;!#33;!#34;!#35;!#52;!#53;!#85]~[#6;!-]"),
  list(name = "Aldehyde", smarts = "[$([CX3H][#6]),$([CX3H2])]=[OX1]"),
  list(name = "Ketone", smarts = "[#6][CX3](=[OX1])[#6]"),
  list(name = "Thioaldehyde", smarts = "[$([CX3H][#6]),$([CX3H2])]=[SX1]"),
  list(name = "Thioketone", smarts = "[#6][CX3](=[SX1])[#6]"),
  list(name = "Imine", smarts = "[NX2;$([N][#6]),$([NH]);!$([N][CX3]=[#7,#8,#15,#16])]=[CX3;$([CH2]),$([CH][#6]),$([C]([#6])[#6])]"),
  list(name = "Immonium", smarts = "[NX3+;!$([N][!#6]);!$([N][CX3]=[#7,#8,#15,#16])]"),
  list(name = "Oxime", smarts = "[NX2](=[CX3;$([CH2]),$([CH][#6]),$([C]([#6])[#6])])[OX2H]"),
  list(name = "Oximether", smarts = "[NX2](=[CX3;$([CH2]),$([CH][#6]),$([C]([#6])[#6])])[OX2][#6;!$(C=[#7,#8])]"),
  list(name = "Acetal", smarts = "[OX2]([#6;!$(C=[O,S,N])])[CX4;!$(C(O)(O)[!#6])][OX2][#6;!$(C=[O,S,N])]"),
  list(name = "Hemiacetal", smarts = "[OX2H][CX4;!$(C(O)(O)[!#6])][OX2][#6;!$(C=[O,S,N])]"),
  list(name = "Aminal", smarts = "[NX3v3;!$(NC=[#7,#8,#15,#16])]([#6])[CX4;!$(C(N)(N)[!#6])][NX3v3;!$(NC=[#7,#8,#15,#16])][#6]"),
  list(name = "Hemiaminal", smarts = "[NX3v3;!$(NC=[#7,#8,#15,#16])]([#6])[CX4;!$(C(N)(N)[!#6])][OX2H]"),
  list(name = "Thioacetal", smarts = "[SX2]([#6;!$(C=[O,S,N])])[CX4;!$(C(S)(S)[!#6])][SX2][#6;!$(C=[O,S,N])]"),
  list(name = "Thiohemiacetal", smarts = "[SX2]([#6;!$(C=[O,S,N])])[CX4;!$(C(S)(S)[!#6])][OX2H]"),
  list(name = "Halogen_acetal_like", smarts = "[NX3v3,SX2,OX2;!$(*C=[#7,#8,#15,#16])][CX4;!$(C([N,S,O])([N,S,O])[!#6])][FX1,ClX1,BrX1,IX1]"),
  list(name = "Acetal_like", smarts = "[NX3v3,SX2,OX2;!$(*C=[#7,#8,#15,#16])][CX4;!$(C([N,S,O])([N,S,O])[!#6])][FX1,ClX1,BrX1,IX1,NX3v3,SX2,OX2;!$(*C=[#7,#8,#15,#16])]"),
  list(name = "Halogenmethylen_ester_and_similar", smarts = "[NX3v3,SX2,OX2;$(**=[#7,#8,#15,#16])][CX4;!$(C([N,S,O])([N,S,O])[!#6])][FX1,ClX1,BrX1,IX1]"),
  list(name = "NOS_methylen_ester_and_similar", smarts = "[NX3v3,SX2,OX2;$(**=[#7,#8,#15,#16])][CX4;!$(C([N,S,O])([N,S,O])[!#6])][NX3v3,SX2,OX2;!$(*C=[#7,#8,#15,#16])]"),
  list(name = "Hetero_methylen_ester_and_similar", smarts = "[NX3v3,SX2,OX2;$(**=[#7,#8,#15,#16])][CX4;!$(C([N,S,O])([N,S,O])[!#6])][FX1,ClX1,BrX1,IX1,NX3v3,SX2,OX2;!$(*C=[#7,#8,#15,#16])]"),
  list(name = "Cyanhydrine", smarts = "[NX1]#[CX2][CX4;$([CH2]),$([CH]([CX2])[#6]),$(C([CX2])([#6])[#6])][OX2H]"),
  list(name = "Chloroalkene", smarts = "[ClX1][CX3]=[CX3]"),
  list(name = "Fluoroalkene", smarts = "[FX1][CX3]=[CX3]"),
  list(name = "Bromoalkene", smarts = "[BrX1][CX3]=[CX3]"),
  list(name = "Iodoalkene", smarts = "[IX1][CX3]=[CX3]"),
  list(name = "Enol", smarts = "[OX2H][CX3;$([H1]),$(C[#6])]=[CX3]"),
  list(name = "Endiol", smarts = "[OX2H][CX3;$([H1]),$(C[#6])]=[CX3;$([H1]),$(C[#6])][OX2H]"),
  list(name = "Enolether", smarts = "[OX2]([#6;!$(C=[N,O,S])])[CX3;$([H0][#6]),$([H1])]=[CX3]"),
  list(name = "Enolester", smarts = "[OX2]([CX3]=[OX1])[#6X3;$([#6][#6]),$([H1])]=[#6X3;!$(C[OX2H])]"),
  list(name = "Enamine", smarts = "[NX3;$([NH2][CX3]),$([NH1]([CX3])[#6]),$([N]([CX3])([#6])[#6]);!$([N]*=[#7,#8,#15,#16])][CX3;$([CH]),$([C][#6])]=[CX3]"),
  list(name = "Thioenol", smarts = "[SX2H][CX3;$([H1]),$(C[#6])]=[CX3]"),
  list(name = "Thioenolether", smarts = "[SX2]([#6;!$(C=[N,O,S])])[CX3;$(C[#6]),$([CH])]=[CX3]"),
  list(name = "Acylchloride", smarts = "[CX3;$([R0][#6]),$([H1R0])](=[OX1])[ClX1]"),
  list(name = "Acylfluoride", smarts = "[CX3;$([R0][#6]),$([H1R0])](=[OX1])[FX1]"),
  list(name = "Acylbromide", smarts = "[CX3;$([R0][#6]),$([H1R0])](=[OX1])[BrX1]"),
  list(name = "Acyliodide", smarts = "[CX3;$([R0][#6]),$([H1R0])](=[OX1])[IX1]"),
  list(name = "Acylhalide", smarts = "[CX3;$([R0][#6]),$([H1R0])](=[OX1])[FX1,ClX1,BrX1,IX1]"),
  list(name = "Carboxylic_acid", smarts = "[CX3;$([R0][#6]),$([H1R0])](=[OX1])[$([OX2H]),$([OX1-])]"),
  list(name = "Carboxylic_ester", smarts = "[CX3;$([R0][#6]),$([H1R0])](=[OX1])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Lactone", smarts = "[#6][#6X3R](=[OX1])[#8X2][#6;!$(C=[O,N,S])]"),
  list(name = "Carboxylic_anhydride", smarts = "[CX3;$([H0][#6]),$([H1])](=[OX1])[#8X2][CX3;$([H0][#6]),$([H1])](=[OX1])"),
  list(name = "Carboxylic_acid_derivative", smarts = "[$([#6X3H0][#6]),$([#6X3H])](=[!#6])[!#6]"),
  list(name = "Carbothioic_acid", smarts = "[CX3;!R;$([C][#6]),$([CH]);$([C](=[OX1])[$([SX2H]),$([SX1-])]),$([C](=[SX1])[$([OX2H]),$([OX1-])])]"),
  list(name = "Carbothioic_S_ester", smarts = "[CX3;$([R0][#6]),$([H1R0])](=[OX1])[SX2][#6;!$(C=[O,N,S])]"),
  list(name = "Carbothioic_S_lactone", smarts = "[#6][#6X3R](=[OX1])[#16X2][#6;!$(C=[O,N,S])]"),
  list(name = "Carbothioic_O_ester", smarts = "[CX3;$([H0][#6]),$([H1])](=[SX1])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Carbothioic_O_lactone", smarts = "[#6][#6X3R](=[SX1])[#8X2][#6;!$(C=[O,N,S])]"),
  list(name = "Carbothioic_halide", smarts = "[CX3;$([H0][#6]),$([H1])](=[SX1])[FX1,ClX1,BrX1,IX1]"),
  list(name = "Carbodithioic_acid", smarts = "[CX3;!R;$([C][#6]),$([CH]);$([C](=[SX1])[SX2H])]"),
  list(name = "Carbodithioic_ester", smarts = "[CX3;!R;$([C][#6]),$([CH]);$([C](=[SX1])[SX2][#6;!$(C=[O,N,S])])]"),
  list(name = "Carbodithiolactone", smarts = "[#6][#6X3R](=[SX1])[#16X2][#6;!$(C=[O,N,S])]"),
  list(name = "Amide", smarts = "[CX3;$([R0][#6]),$([H1R0])](=[OX1])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Primary_amide", smarts = "[CX3;$([R0][#6]),$([H1R0])](=[OX1])[NX3H2]"),
  list(name = "Secondary_amide", smarts = "[CX3;$([R0][#6]),$([H1R0])](=[OX1])[#7X3H1][#6;!$(C=[O,N,S])]"),
  list(name = "Tertiary_amide", smarts = "[CX3;$([R0][#6]),$([H1R0])](=[OX1])[#7X3H0]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])]"),
  list(name = "Lactam", smarts = "[#6R][#6X3R](=[OX1])[#7X3;$([H1][#6;!$(C=[O,N,S])]),$([H0]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Alkyl_imide", smarts = "[#6X3;$([H0][#6]),$([H1])](=[OX1])[#7X3H0]([#6])[#6X3;$([H0][#6]),$([H1])](=[OX1])"),
  list(name = "N_hetero_imide", smarts = "[#6X3;$([H0][#6]),$([H1])](=[OX1])[#7X3H0]([!#6])[#6X3;$([H0][#6]),$([H1])](=[OX1])"),
  list(name = "Imide_acidic", smarts = "[#6X3;$([H0][#6]),$([H1])](=[OX1])[#7X3H1][#6X3;$([H0][#6]),$([H1])](=[OX1])"),
  list(name = "Thioamide", smarts = "[$([CX3;!R][#6]),$([CX3H;!R])](=[SX1])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Thiolactam", smarts = "[#6R][#6X3R](=[SX1])[#7X3;$([H1][#6;!$(C=[O,N,S])]),$([H0]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Oxim ester", smarts = "[#6X3;$([H0][#6]),$([H1])](=[OX1])[#8X2][#7X2]=,:[#6X3;$([H0]([#6])[#6]),$([H1][#6]),$([H2])]"),
  list(name = "Amidine", smarts = "[NX3;!$(NC=[O,S])][CX3;$([CH]),$([C][#6])]=[NX2;!$(NC=[O,S])]"),
  list(name = "Hydroxamic_acid", smarts = "[CX3;$([H0][#6]),$([H1])](=[OX1])[#7X3;$([H1]),$([H0][#6;!$(C=[O,N,S])])][$([OX2H]),$([OX1-])]"),
  list(name = "Hydroxamic_acid_ester", smarts = "[CX3;$([H0][#6]),$([H1])](=[OX1])[#7X3;$([H1]),$([H0][#6;!$(C=[O,N,S])])][OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Imidoacid", smarts = "[CX3R0;$([H0][#6]),$([H1])](=[NX2;$([H1]),$([H0][#6;!$(C=[O,N,S])])])[$([OX2H]),$([OX1-])]"),
  list(name = "Imidoacid_cyclic", smarts = "[#6R][#6X3R](=,:[#7X2;$([H1]),$([H0][#6;!$(C=[O,N,S])])])[$([OX2H]),$([OX1-])]"),
  list(name = "Imidoester", smarts = "[CX3R0;$([H0][#6]),$([H1])](=[NX2;$([H1]),$([H0][#6;!$(C=[O,N,S])])])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Imidolactone", smarts = "[#6R][#6X3R](=,:[#7X2;$([H1]),$([H0][#6;!$(C=[O,N,S])])])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Imidothioacid", smarts = "[CX3R0;$([H0][#6]),$([H1])](=[NX2;$([H1]),$([H0][#6;!$(C=[O,N,S])])])[$([SX2H]),$([SX1-])]"),
  list(name = "Imidothioacid_cyclic", smarts = "[#6R][#6X3R](=,:[#7X2;$([H1]),$([H0][#6;!$(C=[O,N,S])])])[$([SX2H]),$([SX1-])]"),
  list(name = "Imidothioester", smarts = "[CX3R0;$([H0][#6]),$([H1])](=[NX2;$([H1]),$([H0][#6;!$(C=[O,N,S])])])[SX2][#6;!$(C=[O,N,S])]"),
  list(name = "Imidothiolactone", smarts = "[#6R][#6X3R](=,:[#7X2;$([H1]),$([H0][#6;!$(C=[O,N,S])])])[SX2][#6;!$(C=[O,N,S])]"),
  list(name = "Imidolactam", smarts = "[#6][#6X3R;$([H0](=[NX2;!$(N(=[#6X3][#7X3])C=[O,S])])[#7X3;!$(N([#6X3]=[#7X2])C=[O,S])]),$([H0](-[NX3;!$(N([#6X3]=[#7X2])C=[O,S])])=,:[#7X2;!$(N(=[#6X3][#7X3])C=[O,S])])]"),
  list(name = "Imidoylhalide", smarts = "[CX3R0;$([H0][#6]),$([H1])](=[NX2;$([H1]),$([H0][#6;!$(C=[O,N,S])])])[FX1,ClX1,BrX1,IX1]"),
  list(name = "Imidoylhalide_cyclic", smarts = "[#6R][#6X3R](=,:[#7X2;$([H1]),$([H0][#6;!$(C=[O,N,S])])])[FX1,ClX1,BrX1,IX1]"),
  list(name = "Amidrazone", smarts = "[$([$([#6X3][#6]),$([#6X3H])](=[#7X2v3])[#7X3v3][#7X3v3]),$([$([#6X3][#6]),$([#6X3H])]([#7X3v3])=[#7X2v3][#7X3v3])]"),
  list(name = "Alpha_aminoacid", smarts = "[NX3,NX4+;!$([N]~[!#6]);!$([N]*~[#7,#8,#15,#16])][C][CX3](=[OX1])[OX2H,OX1-]"),
  list(name = "Alpha_hydroxyacid", smarts = "[OX2H][C][CX3](=[OX1])[OX2H,OX1-]"),
  list(name = "Peptide_middle", smarts = "[NX3;$([N][CX3](=[OX1])[C][NX3,NX4+])][C][CX3](=[OX1])[NX3;$([N][C][CX3](=[OX1])[NX3,OX2,OX1-])]"),
  list(name = "Peptide_C_term", smarts = "[NX3;$([N][CX3](=[OX1])[C][NX3,NX4+])][C][CX3](=[OX1])[OX2H,OX1-]"),
  list(name = "Peptide_N_term", smarts = "[NX3,NX4+;!$([N]~[!#6]);!$([N]*~[#7,#8,#15,#16])][C][CX3](=[OX1])[NX3;$([N][C][CX3](=[OX1])[NX3,OX2,OX1-])]"),
  list(name = "Carboxylic_orthoester", smarts = "[#6][OX2][CX4;$(C[#6]),$([CH])]([OX2][#6])[OX2][#6]"),
  list(name = "Ketene", smarts = "[CX3]=[CX2]=[OX1]"),
  list(name = "Ketenacetal", smarts = "[#7X2,#8X3,#16X2;$(*[#6,#14])][#6X3]([#7X2,#8X3,#16X2;$(*[#6,#14])])=[#6X3]"),
  list(name = "Nitrile", smarts = "[NX1]#[CX2]"),
  list(name = "Isonitrile", smarts = "[CX1-]#[NX2+]"),
  list(name = "Vinylogous_carbonyl_or_carboxyl_derivative", smarts = "[#6X3](=[OX1])[#6X3]=,:[#6X3][#7,#8,#16,F,Cl,Br,I]"),
  list(name = "Vinylogous_acid", smarts = "[#6X3](=[OX1])[#6X3]=,:[#6X3][$([OX2H]),$([OX1-])]"),
  list(name = "Vinylogous_ester", smarts = "[#6X3](=[OX1])[#6X3]=,:[#6X3][#6;!$(C=[O,N,S])]"),
  list(name = "Vinylogous_amide", smarts = "[#6X3](=[OX1])[#6X3]=,:[#6X3][#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Vinylogous_halide", smarts = "[#6X3](=[OX1])[#6X3]=,:[#6X3][FX1,ClX1,BrX1,IX1]"),
  list(name = "Carbonic_acid_dieester", smarts = "[#6;!$(C=[O,N,S])][#8X2][#6X3](=[OX1])[#8X2][#6;!$(C=[O,N,S])]"),
  list(name = "Carbonic_acid_esterhalide", smarts = "[#6;!$(C=[O,N,S])][OX2;!R][CX3](=[OX1])[OX2][FX1,ClX1,BrX1,IX1]"),
  list(name = "Carbonic_acid_monoester", smarts = "[#6;!$(C=[O,N,S])][OX2;!R][CX3](=[OX1])[$([OX2H]),$([OX1-])]"),
  list(name = "Carbonic_acid_derivatives", smarts = "[!#6][#6X3](=[!#6])[!#6]"),
  list(name = "Thiocarbonic_acid_dieester", smarts = "[#6;!$(C=[O,N,S])][#8X2][#6X3](=[SX1])[#8X2][#6;!$(C=[O,N,S])]"),
  list(name = "Thiocarbonic_acid_esterhalide", smarts = "[#6;!$(C=[O,N,S])][OX2;!R][CX3](=[SX1])[OX2][FX1,ClX1,BrX1,IX1]"),
  list(name = "Thiocarbonic_acid_monoester", smarts = "[#6;!$(C=[O,N,S])][OX2;!R][CX3](=[SX1])[$([OX2H]),$([OX1-])]"),
  list(name = "Urea", smarts = "[#7X3;!$([#7][!#6])][#6X3](=[OX1])[#7X3;!$([#7][!#6])]"),
  list(name = "Thiourea", smarts = "[#7X3;!$([#7][!#6])][#6X3](=[SX1])[#7X3;!$([#7][!#6])]"),
  list(name = "Isourea", smarts = "[#7X2;!$([#7][!#6])]=,:[#6X3]([#8X2&!$([#8][!#6]),OX1-])[#7X3;!$([#7][!#6])]"),
  list(name = "Isothiourea", smarts = "[#7X2;!$([#7][!#6])]=,:[#6X3]([#16X2&!$([#16][!#6]),SX1-])[#7X3;!$([#7][!#6])]"),
  list(name = "Guanidine", smarts = "[N;v3X3,v4X4+][CX3](=[N;v3X2,v4X3+])[N;v3X3,v4X4+]"),
  list(name = "Carbaminic_acid", smarts = "[NX3]C(=[OX1])[O;X2H,X1-]"),
  list(name = "Urethan", smarts = "[#7X3][#6](=[OX1])[#8X2][#6]"),
  list(name = "Biuret", smarts = "[#7X3][#6](=[OX1])[#7X3][#6](=[OX1])[#7X3]"),
  list(name = "Semicarbazide", smarts = "[#7X3][#7X3][#6X3]([#7X3;!$([#7][#7])])=[OX1]"),
  list(name = "Carbazide", smarts = "[#7X3][#7X3][#6X3]([#7X3][#7X3])=[OX1]"),
  list(name = "Semicarbazone", smarts = "[#7X2](=[#6])[#7X3][#6X3]([#7X3;!$([#7][#7])])=[OX1]"),
  list(name = "Carbazone", smarts = "[#7X2](=[#6])[#7X3][#6X3]([#7X3][#7X3])=[OX1]"),
  list(name = "Thiosemicarbazide", smarts = "[#7X3][#7X3][#6X3]([#7X3;!$([#7][#7])])=[SX1]"),
  list(name = "Thiocarbazide", smarts = "[#7X3][#7X3][#6X3]([#7X3][#7X3])=[SX1]"),
  list(name = "Thiosemicarbazone", smarts = "[#7X2](=[#6])[#7X3][#6X3]([#7X3;!$([#7][#7])])=[SX1]"),
  list(name = "Thiocarbazone", smarts = "[#7X2](=[#6])[#7X3][#6X3]([#7X3][#7X3])=[SX1]"),
  list(name = "Isocyanate", smarts = "[NX2]=[CX2]=[OX1]"),
  list(name = "Cyanate", smarts = "[OX2][CX2]#[NX1]"),
  list(name = "Isothiocyanate", smarts = "[NX2]=[CX2]=[SX1]"),
  list(name = "Thiocyanate", smarts = "[SX2][CX2]#[NX1]"),
  list(name = "Carbodiimide", smarts = "[NX2]=[CX2]=[NX2]"),
  list(name = "Orthocarbonic_derivatives", smarts = "[CX4H0]([O,S,#7])([O,S,#7])([O,S,#7])[O,S,#7,F,Cl,Br,I]"),
  list(name = "Phenol", smarts = "[OX2H][c]"),
  list(name = "1,2-Diphenol", smarts = "[OX2H][c][c][OX2H]"),
  list(name = "Arylchloride", smarts = "[Cl][c]"),
  list(name = "Arylfluoride", smarts = "[F][c]"),
  list(name = "Arylbromide", smarts = "[Br][c]"),
  list(name = "Aryliodide", smarts = "[I][c]"),
  list(name = "Arylthiol", smarts = "[SX2H][c]"),
  list(name = "Iminoarene", smarts = "[c]=[NX2;$([H1]),$([H0][#6;!$([C]=[N,S,O])])]"),
  list(name = "Oxoarene", smarts = "[c]=[OX1]"),
  list(name = "Thioarene", smarts = "[c]=[SX1]"),
  list(name = "Hetero_N_basic_H", smarts = "[nX3H1+0]"),
  list(name = "Hetero_N_basic_no_H", smarts = "[nX3H0+0]"),
  list(name = "Hetero_N_nonbasic", smarts = "[nX2,nX3+]"),
  list(name = "Hetero_O", smarts = "[o]"),
  list(name = "Hetero_S", smarts = "[sX2]"),
  list(name = "Heteroaromatic", smarts = "[a;!c]"),
  list(name = "Nitrite", smarts = "[NX2](=[OX1])[O;$([X2]),$([X1-])]"),
  list(name = "Thionitrite", smarts = "[SX2][NX2]=[OX1]"),
  list(name = "Nitrate", smarts = "[$([NX3](=[OX1])(=[OX1])[O;$([X2]),$([X1-])]),$([NX3+]([OX1-])(=[OX1])[O;$([X2]),$([X1-])])]"),
  list(name = "Nitro", smarts = "[$([NX3](=O)=O),$([NX3+](=O)[O-])][!#8]"),
  list(name = "Nitroso", smarts = "[NX2](=[OX1])[!#7;!#8]"),
  list(name = "Azide", smarts = "[NX1]~[NX2]~[NX2,NX1]"),
  list(name = "Acylazide", smarts = "[CX3](=[OX1])[NX2]~[NX2]~[NX1]"),
  list(name = "Diazo", smarts = "[$([#6]=[NX2+]=[NX1-]),$([#6-]-[NX2+]#[NX1])]"),
  list(name = "Diazonium", smarts = "[#6][NX2+]#[NX1]"),
  list(name = "Nitrosamine", smarts = "[#7;!$(N*=O)][NX2]=[OX1]"),
  list(name = "Nitrosamide", smarts = "[NX2](=[OX1])N-*=O"),
  list(name = "N-Oxide", smarts = "[$([#7+][OX1-]),$([#7v5]=[OX1]);!$([#7](~[O])~[O]);!$([#7]=[#7])]"),
  list(name = "Hydrazine", smarts = "[NX3;$([H2]),$([H1][#6]),$([H0]([#6])[#6]);!$(NC=[O,N,S])][NX3;$([H2]),$([H1][#6]),$([H0]([#6])[#6]);!$(NC=[O,N,S])]"),
  list(name = "Hydrazone", smarts = "[NX3;$([H2]),$([H1][#6]),$([H0]([#6])[#6]);!$(NC=[O,N,S])][NX2]=[#6]"),
  list(name = "Hydroxylamine", smarts = "[NX3;$([H2]),$([H1][#6]),$([H0]([#6])[#6]);!$(NC=[O,N,S])][OX2;$([H1]),$(O[#6;!$(C=[N,O,S])])]"),
  list(name = "Sulfon", smarts = "[$([SX4](=[OX1])(=[OX1])([#6])[#6]),$([SX4+2]([OX1-])([OX1-])([#6])[#6])]"),
  list(name = "Sulfoxide", smarts = "[$([SX3](=[OX1])([#6])[#6]),$([SX3+]([OX1-])([#6])[#6])]"),
  list(name = "Sulfonium", smarts = "[S+;!$([S]~[!#6]);!$([S]*~[#7,#8,#15,#16])]"),
  list(name = "Sulfuric_acid", smarts = "[SX4](=[OX1])(=[OX1])([$([OX2H]),$([OX1-])])[$([OX2H]),$([OX1-])]"),
  list(name = "Sulfuric_monoester", smarts = "[SX4](=[OX1])(=[OX1])([$([OX2H]),$([OX1-])])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Sulfuric_diester", smarts = "[SX4](=[OX1])(=[OX1])([OX2][#6;!$(C=[O,N,S])])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Sulfuric_monoamide", smarts = "[SX4](=[OX1])(=[OX1])([#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])])[$([OX2H]),$([OX1-])]"),
  list(name = "Sulfuric_diamide", smarts = "[SX4](=[OX1])(=[OX1])([#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Sulfuric_esteramide", smarts = "[SX4](=[OX1])(=[OX1])([#7X3][#6;!$(C=[O,N,S])])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Sulfuric_derivative", smarts = "[SX4D4](=[!#6])(=[!#6])([!#6])[!#6]"),
  list(name = "Sulfonic_acid", smarts = "[SX4;$([H1]),$([H0][#6])](=[OX1])(=[OX1])[$([OX2H]),$([OX1-])]"),
  list(name = "Sulfonamide", smarts = "[SX4;$([H1]),$([H0][#6])](=[OX1])(=[OX1])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Sulfonic_ester", smarts = "[SX4;$([H1]),$([H0][#6])](=[OX1])(=[OX1])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Sulfonic_halide", smarts = "[SX4;$([H1]),$([H0][#6])](=[OX1])(=[OX1])[FX1,ClX1,BrX1,IX1]"),
  list(name = "Sulfonic_derivative", smarts = "[SX4;$([H1]),$([H0][#6])](=[!#6])(=[!#6])[!#6]"),
  list(name = "Sulfinic_acid", smarts = "[SX3;$([H1]),$([H0][#6])](=[OX1])[$([OX2H]),$([OX1-])]"),
  list(name = "Sulfinic_amide", smarts = "[SX3;$([H1]),$([H0][#6])](=[OX1])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Sulfinic_ester", smarts = "[SX3;$([H1]),$([H0][#6])](=[OX1])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Sulfinic_halide", smarts = "[SX3;$([H1]),$([H0][#6])](=[OX1])[FX1,ClX1,BrX1,IX1]"),
  list(name = "Sulfinic_derivative", smarts = "[SX3;$([H1]),$([H0][#6])](=[!#6])[!#6]"),
  list(name = "Sulfenic_acid", smarts = "[SX2;$([H1]),$([H0][#6])][$([OX2H]),$([OX1-])]"),
  list(name = "Sulfenic_amide", smarts = "[SX2;$([H1]),$([H0][#6])][#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Sulfenic_ester", smarts = "[SX2;$([H1]),$([H0][#6])][OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Sulfenic_halide", smarts = "[SX2;$([H1]),$([H0][#6])][FX1,ClX1,BrX1,IX1]"),
  list(name = "Sulfenic_derivative", smarts = "[SX2;$([H1]),$([H0][#6])][!#6]"),
  list(name = "Phosphine", smarts = "[PX3;$([H3]),$([H2][#6]),$([H1]([#6])[#6]),$([H0]([#6])([#6])[#6])]"),
  list(name = "Phosphine_oxide", smarts = "[PX4;$([H3]=[OX1]),$([H2](=[OX1])[#6]),$([H1](=[OX1])([#6])[#6]),$([H0](=[OX1])([#6])([#6])[#6])]"),
  list(name = "Phosphonium", smarts = "[P+;!$([P]~[!#6]);!$([P]*~[#7,#8,#15,#16])]"),
  list(name = "Phosphorylen", smarts = "[PX4;$([H3]=[CX3]),$([H2](=[CX3])[#6]),$([H1](=[CX3])([#6])[#6]),$([H0](=[CX3])([#6])([#6])[#6])]"),
  list(name = "Phosphonic_acid", smarts = "[PX4;$([H1]),$([H0][#6])](=[OX1])([$([OX2H]),$([OX1-])])[$([OX2H]),$([OX1-])]"),
  list(name = "Phosphonic_monoester", smarts = "[PX4;$([H1]),$([H0][#6])](=[OX1])([$([OX2H]),$([OX1-])])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Phosphonic_diester", smarts = "[PX4;$([H1]),$([H0][#6])](=[OX1])([OX2][#6;!$(C=[O,N,S])])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Phosphonic_monoamide", smarts = "[PX4;$([H1]),$([H0][#6])](=[OX1])([$([OX2H]),$([OX1-])])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Phosphonic_diamide", smarts = "[PX4;$([H1]),$([H0][#6])](=[OX1])([#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Phosphonic_esteramide", smarts = "[PX4;$([H1]),$([H0][#6])](=[OX1])([OX2][#6;!$(C=[O,N,S])])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Phosphonic_acid_derivative", smarts = "[PX4;$([H1]),$([H0][#6])](=[!#6])([!#6])[!#6]"),
  list(name = "Phosphoric_acid", smarts = "[PX4D4](=[OX1])([$([OX2H]),$([OX1-])])([$([OX2H]),$([OX1-])])[$([OX2H]),$([OX1-])]"),
  list(name = "Phosphoric_monoester", smarts = "[PX4D4](=[OX1])([$([OX2H]),$([OX1-])])([$([OX2H]),$([OX1-])])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Phosphoric_diester", smarts = "[PX4D4](=[OX1])([$([OX2H]),$([OX1-])])([OX2][#6;!$(C=[O,N,S])])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Phosphoric_triester", smarts = "[PX4D4](=[OX1])([OX2][#6;!$(C=[O,N,S])])([OX2][#6;!$(C=[O,N,S])])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Phosphoric_monoamide", smarts = "[PX4D4](=[OX1])([$([OX2H]),$([OX1-])])([$([OX2H]),$([OX1-])])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Phosphoric_diamide", smarts = "[PX4D4](=[OX1])([$([OX2H]),$([OX1-])])([#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Phosphoric_triamide", smarts = "[PX4D4](=[OX1])([#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])])([#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Phosphoric_monoestermonoamide", smarts = "[PX4D4](=[OX1])([$([OX2H]),$([OX1-])])([OX2][#6;!$(C=[O,N,S])])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Phosphoric_diestermonoamide", smarts = "[PX4D4](=[OX1])([OX2][#6;!$(C=[O,N,S])])([OX2][#6;!$(C=[O,N,S])])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Phosphoric_monoesterdiamide", smarts = "[PX4D4](=[OX1])([OX2][#6;!$(C=[O,N,S])])([#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Phosphoric_acid_derivative", smarts = "[PX4D4](=[!#6])([!#6])([!#6])[!#6]"),
  list(name = "Phosphinic_acid", smarts = "[PX4;$([H2]),$([H1][#6]),$([H0]([#6])[#6])](=[OX1])[$([OX2H]),$([OX1-])]"),
  list(name = "Phosphinic_ester", smarts = "[PX4;$([H2]),$([H1][#6]),$([H0]([#6])[#6])](=[OX1])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Phosphinic_amide", smarts = "[PX4;$([H2]),$([H1][#6]),$([H0]([#6])[#6])]"),
  list(name = "Phosphinic_acid_derivative", smarts = "[PX4;$([H2]),$([H1][#6]),$([H0]([#6])[#6])](=[!#6])[!#6]"),
  list(name = "Phosphonous_acid", smarts = "[PX3;$([H1]),$([H0][#6])]([$([OX2H]),$([OX1-])])[$([OX2H]),$([OX1-])]"),
  list(name = "Phosphonous_monoester", smarts = "[PX3;$([H1]),$([H0][#6])]([$([OX2H]),$([OX1-])])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Phosphonous_diester", smarts = "[PX3;$([H1]),$([H0][#6])]([OX2][#6;!$(C=[O,N,S])])[OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Phosphonous_monoamide", smarts = "[PX3;$([H1]),$([H0][#6])]([$([OX2H]),$([OX1-])])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Phosphonous_diamide", smarts ="[PX3;$([H1]),$([H0][#6])]([#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])])([#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])])"), # modified
  list(name = "Phosphonous_esteramide", smarts = "[PX3;$([H1]),$([H0][#6])]([OX2][#6;!$(C=[O,N,S])])[#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Phosphonous_derivatives", smarts = "[PX3;$([D2]),$([D3][#6])]([!#6])[!#6]"),
  list(name = "Phosphinous_acid", smarts = "[PX3;$([H2]),$([H1][#6]),$([H0]([#6])[#6])][$([OX2H]),$([OX1-])]"),
  list(name = "Phosphinous_ester", smarts = "[PX3;$([H2]),$([H1][#6]),$([H0]([#6])[#6])][OX2][#6;!$(C=[O,N,S])]"),
  list(name = "Phosphinous_amide", smarts = "[PX3;$([H2]),$([H1][#6]),$([H0]([#6])[#6])][#7X3;$([H2]),$([H1][#6;!$(C=[O,N,S])]),$([#7]([#6;!$(C=[O,N,S])])[#6;!$(C=[O,N,S])])]"),
  list(name = "Phosphinous_derivatives", smarts = "[PX3;$([H2]),$([H1][#6]),$([H0]([#6])[#6])][!#6]"),
  list(name = "Quart_silane", smarts = "[SiX4]([#6])([#6])([#6])[#6]"),
  list(name = "Non-quart_silane", smarts = "[SiX4;$([H1]([#6])([#6])[#6]),$([H2]([#6])[#6]),$([H3][#6]),$([H4])]"),
  list(name = "Silylmonohalide", smarts = "[SiX4]([FX1,ClX1,BrX1,IX1])([#6])([#6])[#6]"),
  list(name = "Het_trialkylsilane", smarts = "[SiX4]([!#6])([#6])([#6])[#6]"),
  list(name = "Dihet_dialkylsilane", smarts = "[SiX4]([!#6])([!#6])([#6])[#6]"),
  list(name = "Trihet_alkylsilane", smarts = "[SiX4]([!#6])([!#6])([!#6])[#6]"),
  list(name = "Silicic_acid_derivative", smarts = "[SiX4]([!#6])([!#6])([!#6])[!#6]"),
  list(name = "Trialkylborane", smarts = "[BX3]([#6])([#6])[#6]"),
  list(name = "Boric_acid_derivatives", smarts = "[BX3]([!#6])([!#6])[!#6]"),
  list(name = "Boronic_acid_derivative", smarts = "[BX3]([!#6])([!#6])[!#6]"),
  list(name = "Borohydride", smarts = "[BH1,BH2,BH3,BH4]"),
  list(name = "Quaternary_boron", smarts = "[BX4]"),
  list(name = "Aromatic", smarts = "a"),
  list(name = "Heterocyclic", smarts = "[!#6;!R0]"),
  list(name = "Epoxide", smarts = "[OX2r3]1[#6r3][#6r3]1"),
  list(name = "NH_aziridine", smarts = "[NX3H1r3]1[#6r3][#6r3]1"),
  list(name = "Spiro", smarts = "[D4R;$(*(@*)(@*)(@*)@*)]"),
  list(name = "Annelated_rings", smarts = "[R;$(*(@*)(@*)@*);!$([R2;$(*(@*)(@*)(@*)@*)])]@[R;$(*(@*)(@*)@*);!$([R2;$(*(@*)(@*)(@*)@*)])]"),
  list(name = "Bridged_rings", smarts = "[R;$(*(@*)(@*)@*);!$([D4R;$(*(@*)(@*)(@*)@*)]);!$([R;$(*(@*)(@*)@*);!$([R2;$(*(@*)(@*)(@*)@*)])]@[R;$(*(@*)(@*)@*);!$([R2;$(*(@*)(@*)(@*)@*)])])]"),
  list(name = "Sugar_pattern_1", smarts = "[OX2;$([r5]1@C@C@C(O)@C1),$([r6]1@C@C@C(O)@C(O)@C1)]"),
  list(name = "Sugar_pattern_2", smarts = "[OX2;$([r5]1@C(!@[OX2,NX3,SX2,FX1,ClX1,BrX1,IX1])@C@C@C1),$([r6]1@C(!@[OX2,NX3,SX2,FX1,ClX1,BrX1,IX1])@C@C@C@C1)]"),
  list(name = "Sugar_pattern_combi", smarts = "[OX2;$([r5]1@C(!@[OX2,NX3,SX2,FX1,ClX1,BrX1,IX1])@C@C(O)@C1),$([r6]1@C(!@[OX2,NX3,SX2,FX1,ClX1,BrX1,IX1])@C@C(O)@C(O)@C1)]"),
  list(name = "Sugar_pattern_2_reducing", smarts = "[OX2;$([r5]1@C(!@[OX2H1])@C@C@C1),$([r6]1@C(!@[OX2H1])@C@C@C@C1)]"),
  list(name = "Sugar_pattern_2_alpha", smarts = "[OX2;$([r5]1@[C@@](!@[OX2,NX3,SX2,FX1,ClX1,BrX1,IX1])@C@C@C1),$([r6]1@[C@@](!@[OX2,NX3,SX2,FX1,ClX1,BrX1,IX1])@C@C@C@C1)]"),
  list(name = "Sugar_pattern_2_beta", smarts = "[OX2;$([r5]1@[C@](!@[OX2,NX3,SX2,FX1,ClX1,BrX1,IX1])@C@C@C1),$([r6]1@[C@](!@[OX2,NX3,SX2,FX1,ClX1,BrX1,IX1])@C@C@C@C1)]"),
  list(name = "Conjugated_double_bond", smarts = "*=*[*]=,#,:[*]"),
  list(name = "Conjugated_tripple_bond", smarts = "*#*[*]=,#,:[*]"),
  list(name = "Cis_double_bond", smarts = "*/[D2]=[D2]\\*"),
  list(name = "Trans_double_bond", smarts = "*/[D2]=[D2]/*"),
  list(name = "Mixed_anhydrides", smarts = "[$(*=O),$([#16,#14,#5]),$([#7]([#6]=[OX1]))][#8X2][$(*=O),$([#16,#14,#5]),$([#7]([#6]=[OX1]))]"),
  list(name = "Halogen_on_hetero", smarts = "[FX1,ClX1,BrX1,IX1][!#6]"),
  list(name = "Halogen_multi_subst", smarts = "[F,Cl,Br,I;!$([X1]);!$([X0-])]"),
  list(name = "Trifluoromethyl", smarts = "[FX1][CX4;!$([H0][Cl,Br,I]);!$([F][C]([F])([F])[F])]([FX1])([FX1])"),
  list(name = "C_ONS_bond", smarts = "[#6]~[#7,#8,#16]"),
  list(name = "Charged", smarts = "[!+0]"),
  list(name = "Anion", smarts = "[-1,-2,-3,-4,-5,-6,-7]"),
  list(name = "Kation", smarts = "[+1,+2,+3,+4,+5,+6,+7]"),
  list(name = "1,3-Tautomerizable", smarts = "[$([#7X2,OX1,SX1]=*[!H0;!$([a;!n])]),$([#7X3,OX2,SX2;!H0]*=*),$([#7X3,OX2,SX2;!H0]*:n)]"),
  list(name = "1,5-Tautomerizable", smarts = "[$([#7X2,OX1,SX1]=,:**=,:*[!H0;!$([a;!n])]),$([#7X3,OX2,SX2;!H0]*=**=*),$([#7X3,OX2,SX2;!H0]*=,:**:n)]"),
  list(name = "Rotatable_bond", smarts = "[!$(*#*)&!D1]-!@[!$(*#*)&!D1]"),
  list(name = "Michael_acceptor", smarts = "[CX3]=[CX3][$([CX3]=[O,N,S]),$(C#[N]),$([S,P]=[OX1]),$([NX3]=O),$([NX3+](=O)[O-])]"),
  list(name = "Dicarbodiazene", smarts = "[CX3](=[OX1])[NX2]=[NX2][CX3](=[OX1])"),
  list(name = "CH-acidic", smarts = "[$([CX4;!$([H0]);!$(C[!#6;!$([P,S]=O);!$(N(~O)~O)])][$([CX3]=[O,N,S]),$(C#[N]),$([S,P]=[OX1]),$([NX3]=O),$([NX3+](=O)[O-]);!$(*[S,O,N;H1,H2]);!$([*+0][S,O;X1-])]),$([CX4;!$([H0])]1[CX3]=[CX3][CX3]=[CX3]1)]"),
  list(name = "CH-acidic_strong", smarts = "[CX4;!$([H0]);!$(C[!#6;!$([P,S]=O);!$(N(~O)~O)])]([$([CX3]=[O,N,S]),$(C#[N]),$([S,P]=[OX1]),$([NX3]=O),$([NX3+](=O)[O-]);!$(*[S,O,N;H1,H2]);!$([*+0][S,O;X1-])])[$([CX3]=[O,N,S]),$(C#[N]),$([S,P]=[OX1]),$([NX3]=O),$([NX3+](=O)[O-]);!$(*[S,O,N;H1,H2]);!$([*+0][S,O;X1-])]"),
  list(name = "Chiral_center_specified", smarts = "[$([*@](~*)(~*)(*)*),$([*@H](*)(*)*),$([*@](~*)(*)*),$([*@H](~*)~*)]")
)
```

# Maximum Common Substructure

```{r select-maxfragment-parallel, eval=FALSE}
library(reticulate)
library(future.apply)

smiles_vec <- smiles$smiles  
pairs <- combn(seq_along(smiles_vec), 2, simplify = FALSE)
plan(multisession, workers = 20)  

results_list <- future_lapply(pairs, function(idx_pair) {
  
  library(reticulate)
  library(here)
  source_python(here("scripts/mcs_single_maxfragment.py"))  # re-import inside worker
  
  i <- idx_pair[1]
  j <- idx_pair[2]
  
  mcs_size <- compute_mcs_and_fragment_diff(smiles_vec[i], smiles_vec[j])
  
  list(mol1_index = i, mol2_index = j, mcs_size = mcs_size)
}, future.seed = TRUE)

# Bind all results
results <- do.call(rbind, lapply(results_list, as.data.frame))
write.csv(results, file = here(data_deliv_dir,"results_table_max_frag_size.csv"), row.names = FALSE)
```

## Subsets
```{r subset}
results_selected <- results %>%
  mutate(crit = mcs_size)%>%
  group_by(mol1_index) %>%
  slice(which.min(crit))
```

## MCS Subsets
```{r mcs-subset, eval=FALSE}
# Extract the vectors
rows <- smiles$smiles[results_selected$mol1_index]
cols <- smiles$smiles[results_selected$mol2_index]

comparison_table <- purrr::map2_df(rows, cols, compare_smiles_pair,
                                   .progress = list(
  type = "iterator", 
  format = "Calculating {cli::pb_bar} {cli::pb_percent} {cli::pb_current}/{cli::pb_total}",
  clear = FALSE))

write.csv(comparison_table, file = here(data_deliv_dir,"comparison_table.csv"), row.names = FALSE)
```

## Similarity of MCS
```{r similarity of MCSs}
# Extract the vectors
rows <- comparison_table$common1
cols <- comparison_table$common2

comparison_table$are_similar <- as.double(purrr::map2_lgl(rows, cols, are_smiles_identical))
```

## Add membership groups
```{r add-membership-groups}
results_selected <- results_selected %>% select(-any_of("group"))
results_selected_crit<-results_selected %>% filter(crit<7) 

uid = unique(c(results_selected_crit$mol1_index,results_selected_crit$mol2_index))
nodes <- data.frame(id = uid,label = paste(uid))
edges <- data.frame(from = results_selected_crit$mol1_index,
                    to = results_selected_crit$mol2_index, 
                    width =results_selected_crit$crit,
                    label = paste(results_selected_crit$crit))
g <- graph_from_data_frame(d = edges, vertices = nodes, directed = FALSE)
components <- components(g, mode = "weak")
nodes$group <- components$membership

nodes$atom_count <- unlist(lapply(smiles$smiles[nodes$id], get_atom_count)) 

results_selected <- results_selected%>%
  mutate(id=mol1_index) %>%
  left_join(nodes) %>%
   select(-c(label, id)) %>%
  mutate(group = ifelse(is.na(group), 0, group))

tabulate(results_selected$group+1)
```


### Visualise Network
```{r vis-network, eval=FALSE}
visNetwork(nodes, edges, width = "100%")
```

## Orient graph
```{r orient-graph}

orient_graph_no_multiple_incoming <- function(g) {
  stopifnot(!is_directed(g))
  
  degs <- degree(g)
  node_order <- names(sort(degs, decreasing = TRUE))
  
  g_directed <- make_empty_graph(n = vcount(g), directed = TRUE)
  V(g_directed)$name <- V(g)$name
  
  has_parent <- setNames(rep(FALSE, vcount(g)), V(g)$name)
  
  for (node in node_order) {
    neighbors_node <- neighbors(g, node, mode = "all")
    
    for (nbr in neighbors_node) {
      nbr_name <- V(g)[nbr]$name
      
      # Only consider edge if neighbor has no incoming edge
      if (!has_parent[nbr_name] && node != nbr_name) {
        
        # Check if adding edge would introduce a cycle
        temp_graph <- add_edges(g_directed, c(node, nbr_name))
        if (is_dag(temp_graph)) {
          g_directed <- temp_graph
          has_parent[nbr_name] <- TRUE
        }
      }
    }
  }
  
  return(g_directed)
}

# Apply it
g_directed <- orient_graph_no_multiple_incoming(g)

```

### Visualise Network
```{r}
# Create nodes data frame
nodes <- data.frame(
  id = V(g_directed)$name,
  label = V(g_directed)$name,
  stringsAsFactors = FALSE
)

components <- components(g, mode = "weak")
nodes$group <- components$membership

# Create edges data frame
edges <- igraph::as_data_frame(g_directed, what = "edges")
colnames(edges) <- c("from", "to")

#nodes with no outgoing edges
nodes_noin <- V(g_directed)[degree(g_directed, mode = "in") == 0]
nodes_noin <- names(nodes_noin)

visNetwork(nodes, edges, width = "100%") %>%
  visEdges(arrows = "to")
```

## Equation output:
```{r equation, eval=FALSE}

topo_order <- topo_sort(g_directed, mode = "out")
topo_order <- names(topo_order)

# Initialize a named list to store equations
equations <- setNames(vector("list", length(topo_order)), topo_order)

for (node in sorted_nodes) {
  parents <- names(neighbors(g_directed, node, mode = "in"))
  
  if (length(parents) == 0) {
    # If no parents, it's a root node
    equations[[node]] <- node
  } else {
    # Sum of parents
    equations[[node]] <- paste0(node, " = ", paste(parents, collapse = " + "))
  }
}

# Print all equations
equations_vec <- unlist(equations)
cat(paste(equations_vec, collapse = "\n"))
```

# Print Tables
```{r print-tables}

comparison_table$similarity = results_selected$crit
comparison_table$id1 = results_selected$mol1_index
comparison_table$id2 = results_selected$mol2_index
comparison_table$group = results_selected$group

comparison_table <- comparison_table %>% arrange(group)

comparison_table %>%
  select("id1", "id2", "group", "similarity", "structure") %>%
  kbl(escape = FALSE, format = "html", align = "l") %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

comparison_table %>%
  select("id1", "id2", "similarity", "common1", "common2", "to_remove","to_remove_str","to_add", "to_add_str") %>%
  kbl(escape = FALSE, format = "html", align = "l") %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))
```

# Plot
```{r plot}
plotting_i = function(i, .ilist) {
  data %>% 
    filter(ID %in% c(.ilist$id1[i], .ilist$id2[i])) %>%
    ggplot(aes(x = fi, y = logk, group = ID)) + 
    geom_line(aes(color = logP_ACD)) + 
    labs(
      title = paste(analytes_names$Analyte[.ilist$id1[i]], "\n", analytes_names$Analyte[.ilist$id2[i]]), 
      x = "\u03C6", 
      y = expression(log~k[obs])
    ) + 
    theme_gray(base_size = 10) + 
    theme(legend.position = "none")+
    theme(plot.title = element_text(size = 5), 
          axis.title = element_text(size = 7),
          axis.text = element_text(size = 5))
}

list0 = comparison_table%>% filter(similarity==0)
list1 = comparison_table%>% filter(similarity==1)
list2 = comparison_table%>% filter(similarity==2)
list10 = comparison_table%>% filter(similarity==10)
map(1:min(20, nrow(list0)), \(x) plotting_i(x, list0)) %>% wrap_plots(ncol = 4)
map(1:min(20, nrow(list1)), \(x) plotting_i(x, list1)) %>% wrap_plots(ncol = 4)
map(1:min(20, nrow(list2)), \(x) plotting_i(x, list2)) %>% wrap_plots(ncol = 4)
map(1:min(20, nrow(list10)), \(x) plotting_i(x, list10)) %>% wrap_plots(ncol = 4)
```

# Test
```{r test, eval=FALSE}
# Extract the vectors

idx = 4
smiles1 <- smiles$smiles[results_selected$mol1_index[idx]]
smiles2 <- smiles$smiles[results_selected$mol2_index[idx]]

comparison_table_x <- purrr::map2_df(smiles1, smiles2, compare_smiles_pair)
comparison_table_x$id1 = results_selected$mol1_index[idx]
comparison_table_x$id2 = results_selected$mol2_index[idx]

comparison_table_x%>%
  select("id1", "id2", "structure") %>%
  kbl(escape = FALSE, format = "html", align = "l") %>%
  kable_styling(full_width = FALSE, position = "center", bootstrap_options = c("striped", "hover", "condensed"))

comparison_table_x
```

```{r}
extract_diff_fragments_details <- function(smiles1,smiles2, .mcs_params = mc_params, .fg_hierarchy = fg_hierarchy) {

  mol1 <- Chem$MolFromSmiles(smiles1)
  mol2 <- Chem$MolFromSmiles(smiles2)
  
  mcs_result <- rdFMCS$FindMCS(list(mol1, mol2), parameters = .mcs_params)
  smarts <- mcs_result$smartsString
  common_mol <- Chem$MolFromSmarts(smarts)
  match1 <- mol1$GetSubstructMatch(common_mol)
  match2 <- mol2$GetSubstructMatch(common_mol)

  mol=mol1 
  match_atoms = match1
  
  
all_atoms <- seq_len(mol$GetNumAtoms()) - 1L
  diff_atoms <- setdiff(all_atoms, match_atoms)

  atom_matches <- list()

  for (fg in fg_hierarchy) {
    fg_name <- fg$name
    fg_smarts <- fg$smarts
    fg_mol <- Chem$MolFromSmarts(fg_smarts)
    
    if (is.null(fg_mol)) next

    # Get all matches of the functional group in the molecule
    matches <- mol$GetSubstructMatches(fg_mol)

    if (length(matches) == 0) next

    for (match in matches) {
      match <- as.integer(match)
      for (atom_idx in match) {
        if (atom_idx %in% diff_atoms) {
          key <- as.character(atom_idx)
          if (is.null(atom_matches[[key]])) {
            atom_matches[[key]] <- list(fg_name)
          } else {
            atom_matches[[key]] <- unique(c(atom_matches[[key]], fg_name))
          }
        }
      }
    }
  }

  # Prepare data frame
  rows <- list()
  for (atom_idx in diff_atoms) {
    atom <- mol$GetAtomWithIdx(atom_idx)
    atom_symbol <- atom$GetSymbol()
    fg_list <- atom_matches[[as.character(atom_idx)]]
    fg_str <- if (is.null(fg_list)) NA_character_ else paste(fg_list, collapse = ", ")
    
    rows[[length(rows) + 1]] <- data.frame(
      atom_idx = atom_idx,
      atom_symbol = atom_symbol,
      matched_fg = fg_str,
      stringsAsFactors = FALSE
    )
  }

  df <- do.call(rbind, rows)
  rownames(df) <- NULL
  return(df)
}
 
extend_fg_hierarchy <- function(fg_hierarchy, new_groups) {
  for (group in new_groups) {
    if (!("name" %in% names(group)) || !("smarts" %in% names(group))) {
      warning("Invalid custom functional group structure.")
      next
    }
    fg_hierarchy <- append(fg_hierarchy, list(group))
  }
  return(fg_hierarchy)
}

fg_hierarchy <- FunctionalGroups$BuildFuncGroupHierarchy()

fg_hierarchy <- fg_hierarchy[[1]]
fg_hierarchy <- extend_fg_hierarchy(fg_hierarchy, custom_groups)
fg_hierarchy <- fg_hierarchy[-1]

idx = 4
smiles1 <- smiles$smiles[results_selected$mol1_index[idx]]
smiles2 <- smiles$smiles[results_selected$mol2_index[idx]]

foo1 <- extract_diff_fragments_details(smiles1, smiles2, mcs_params, fg_hierarchy)
foo2 <- extract_diff_fragments_details(smiles2, smiles1, mcs_params, fg_hierarchy)

foo1
foo2
```

# Session info
```{r}
sessionInfo()
```