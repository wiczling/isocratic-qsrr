<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Paweł Wiczling*">
<meta name="dcterms.date" content="2025-06-16">

<title>Model 005</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="model-development-005_files/libs/clipboard/clipboard.min.js"></script>
<script src="model-development-005_files/libs/quarto-html/quarto.js"></script>
<script src="model-development-005_files/libs/quarto-html/popper.min.js"></script>
<script src="model-development-005_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="model-development-005_files/libs/quarto-html/anchor.min.js"></script>
<link href="model-development-005_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="model-development-005_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="model-development-005_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="model-development-005_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="model-development-005_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introductions" id="toc-introductions" class="nav-link active" data-scroll-target="#introductions">Introductions</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a>
  <ul class="collapse">
  <li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data">Load data</a></li>
  <li><a href="#prepare-data" id="toc-prepare-data" class="nav-link" data-scroll-target="#prepare-data">Prepare data</a></li>
  <li><a href="#initial-estimates" id="toc-initial-estimates" class="nav-link" data-scroll-target="#initial-estimates">Initial estimates</a></li>
  </ul></li>
  <li><a href="#data-analysis" id="toc-data-analysis" class="nav-link" data-scroll-target="#data-analysis">Data analysis</a>
  <ul class="collapse">
  <li><a href="#model" id="toc-model" class="nav-link" data-scroll-target="#model">Model</a></li>
  <li><a href="#priors" id="toc-priors" class="nav-link" data-scroll-target="#priors">Priors</a></li>
  </ul></li>
  <li><a href="#stan" id="toc-stan" class="nav-link" data-scroll-target="#stan">Stan</a>
  <ul class="collapse">
  <li><a href="#initialize-variables-and-parameters" id="toc-initialize-variables-and-parameters" class="nav-link" data-scroll-target="#initialize-variables-and-parameters">Initialize variables and parameters</a></li>
  <li><a href="#fitting-the-model" id="toc-fitting-the-model" class="nav-link" data-scroll-target="#fitting-the-model">Fitting the model</a></li>
  <li><a href="#summary-of-model-parameters-table" id="toc-summary-of-model-parameters-table" class="nav-link" data-scroll-target="#summary-of-model-parameters-table">Summary of model parameters (table):</a></li>
  <li><a href="#trace-plots" id="toc-trace-plots" class="nav-link" data-scroll-target="#trace-plots">Trace plots</a></li>
  <li><a href="#summary-of-model-parameters-figures" id="toc-summary-of-model-parameters-figures" class="nav-link" data-scroll-target="#summary-of-model-parameters-figures">Summary of model parameters (figures)</a></li>
  </ul></li>
  <li><a href="#session-info" id="toc-session-info" class="nav-link" data-scroll-target="#session-info">Session info</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Model 005</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Paweł Wiczling* </p>
  </div>
    <div class="quarto-title-meta-contents">
        <p class="affiliation">
            Department of Biopharmaceutics and Pharmacodynamics, Medical University of Gdańsk, Gen.&nbsp;J. Hallera 107, 80-416 Gdańsk, Poland
          </p>
      </div>
    </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 16, 2025</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introductions" class="level1">
<h1>Introductions</h1>
<p>Test t-matrix distributions</p>
</section>
<section id="setup" class="level1">
<h1>Setup</h1>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">cache=</span><span class="cn">TRUE</span>, <span class="at">message=</span><span class="cn">FALSE</span>, <span class="at">error=</span><span class="cn">FALSE</span>, <span class="at">warning=</span><span class="cn">FALSE</span>, <span class="at">comment=</span><span class="cn">NA</span>, <span class="at">out.width=</span><span class="st">'95%'</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbr.bayes)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'dplyr' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'ggplot2' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'patchwork' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'gridExtra' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(naniar)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'naniar' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'knitr' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'tidyverse' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'tibble' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'tidyr' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'readr' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'purrr' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'stringr' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'forcats' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'lubridate' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'glue' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(whisker)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'whisker' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'here' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'posterior' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'bayesplot' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'tidybayes' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'reshape2' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pracma)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'pracma' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mrgmisc)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'GGally' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'igraph' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggraph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'ggraph' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggcorrplot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: pakiet 'ggcorrplot' został zbudowany w wersji R 4.3.3</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">#remotes::install_github("metrumresearchgroup/mrgmisc")</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set_cmdstan_path</span>(<span class="st">"C:/Users/GUMed/.cmdstan/cmdstan-2.36.0"</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10271998</span>) <span class="do">## not required but assures repeatable results</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>select<span class="ot">&lt;-</span>dplyr<span class="sc">::</span>select</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"helper-functions.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="model-development-005_cache/html/settings_6f317e62a28e4a7d5c238e2c6993712d">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">=</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>model_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"model"</span>,<span class="st">"stan"</span>)  </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>figures_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"deliv"</span>,<span class="st">"figures"</span>, <span class="st">"stan"</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>tables_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"deliv"</span>,<span class="st">"tables"</span>, <span class="st">"stan"</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(figures_dir)) <span class="fu">dir.create</span>(figures_dir, <span class="at">recursive =</span> T)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(model_dir)) <span class="fu">dir.create</span>(model_dir, <span class="at">recursive =</span> T)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(tables_dir)) <span class="fu">dir.create</span>(tables_dir, <span class="at">recursive =</span> T)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>data_deliv_dir <span class="ot">=</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>,<span class="st">"deliv"</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>data_derived_dir <span class="ot">=</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>,<span class="st">"derived"</span>)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(data_deliv_dir)) <span class="fu">dir.create</span>(data_deliv_dir, <span class="at">recursive =</span> T)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(data_derived_dir)) <span class="fu">dir.create</span>(data_derived_dir, <span class="at">recursive =</span> T)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>figures_eda_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"deliv"</span>,<span class="st">"figures"</span>, <span class="st">"stan"</span>)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>tables_eda_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"deliv"</span>,<span class="st">"tables"</span>, <span class="st">"stan"</span>)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(figures_eda_dir)) <span class="fu">dir.create</span>(figures_eda_dir, <span class="at">recursive =</span> T)</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(tables_eda_dir)) <span class="fu">dir.create</span>(tables_eda_dir, <span class="at">recursive =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We used a publicly available <a href="www.retentionprediction.org/hplc/database/">dataset</a> that comprises the measurements of RP-HPLC retention times collected for 1026 analytes. The retention times were measured under isocratic conditions on Eclipse Plus C18 (Agilent) stationary phase with 3.5 μm particles. The experiments were conducted using a mixture of two solvents: solvent A, which was made of 0.1% formic acid in water, and solvent B, which was made of 0.1% formic acid in acetonitrile. The column temperature was set at 35^{}C. The data were collected by Boswell et al.&nbsp;and were used to create a method to predict retention time by Back-Calculating the Gradient.</p>
<section id="load-data" class="level2">
<h2 class="anchored" data-anchor-id="load-data">Load data</h2>
<div class="cell" data-hash="model-development-005_cache/html/load-data_1238b10c67f103beba6e742023ba3d06">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(data_deliv_dir, <span class="st">"database_logk_1026.csv"</span>), <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>analytes_names  <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(data_deliv_dir,<span class="st">"database_logk_1026_analyte_names.csv"</span>), <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>smiles <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(data_deliv_dir,<span class="st">"smiles1026.smi"</span>), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>, <span class="at">header =</span> <span class="cn">FALSE</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>data_ACD <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(data_deliv_dir,<span class="st">'ACD_pKas.csv'</span>))</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>data_pH <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(data_deliv_dir,<span class="st">"pH.csv"</span>),<span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>data_ACD<span class="sc">$</span>logP <span class="ot">=</span>data <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(ID, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(logP_ACD)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>data_ACD<span class="sc">$</span>MW <span class="ot">=</span>data <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(ID, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(MW_ACD)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>data_ACD<span class="sc">$</span>logP[<span class="dv">526</span>] <span class="ot">=</span> <span class="fu">mean</span>(data_ACD<span class="sc">$</span>logP, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>fg_df <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="fu">here</span>(data_deliv_dir,<span class="st">"smarts_functional_groups.csv"</span>), <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>descriptor_df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="fu">here</span>(data_deliv_dir,<span class="st">"descriptor_df.csv"</span>), <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>similarity_ltri_rcdk_df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="fu">here</span>(data_deliv_dir,<span class="st">"similarity_ltri_rcdk.csv"</span>), <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>similarity_matrix <span class="ot">&lt;-</span> <span class="fu">make_similarity_matrix_fun</span>(similarity_ltri_rcdk_df)</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>smiles<span class="ot">&lt;-</span>smiles <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">ID=</span>V2,<span class="at">smiles=</span>V1) <span class="sc">%&gt;%</span> <span class="fu">select</span>(ID,smiles)</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>smiles<span class="sc">$</span>smiles[<span class="dv">905</span>] <span class="ot">=</span> <span class="st">"CN(C1CCCCC1N1CCCC1)C(=O)Cc1ccc(c(c1)Cl)Cl"</span> <span class="co"># remove tartrate moiety </span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>smiles<span class="sc">$</span>smiles[<span class="dv">425</span>] <span class="ot">=</span> <span class="st">"CC(Cc1ccc(cc1)OCC(=O)O)NCC(c1cccc(c1)Cl)O"</span> <span class="co"># remove Na+ and dissociation</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>smiles<span class="sc">$</span>smiles[<span class="dv">501</span>] <span class="ot">=</span> <span class="st">"c1ccc(cc1)C1(c2ccccc2)C(=O)NC(=N1)O"</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>smiles<span class="sc">$</span>smiles[<span class="dv">401</span>]<span class="ot">=</span> <span class="st">"CC(C)(C)c1c(CC(C(=O)[OH])[NH2])c(=O)[nH]o1"</span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>smiles<span class="sc">$</span>smiles[<span class="dv">686</span>] <span class="ot">=</span> <span class="st">"CCCCCCCCCCCCCCCC(=O)OC(CC(=O)[OH])C[N+](C)(C)C"</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>smiles<span class="sc">$</span>smiles[<span class="dv">901</span>] <span class="ot">=</span> <span class="st">"CCOC(=Nc1c[n+](no1)N1CCOCC1)[OH]"</span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>analytes_names<span class="sc">$</span>Analyte <span class="ot">&lt;-</span> <span class="fu">iconv</span>(analytes_names<span class="sc">$</span>Analyte, <span class="at">from =</span> <span class="st">""</span>, <span class="at">to =</span> <span class="st">"UTF-8"</span>, <span class="at">sub =</span> <span class="st">"byte"</span>)</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a><span class="co"># dissociated groups at low pH</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>dissociated_groups <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Anions</span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sulfonic_acid"</span>, <span class="st">"Sulfinic_acid"</span>, <span class="st">"Sulfenic_acid"</span>, <span class="st">"Sulfuric_acid"</span>, <span class="st">"Sulfuric_monoester"</span>,</span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Phosphonic_acid"</span>, <span class="st">"Phosphoric_acid"</span>, <span class="st">"Phosphoric_monoester"</span>, <span class="st">"Phosphinic_acid"</span>,</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Phosphonous_acid"</span>, <span class="st">"Phosphinous_acid"</span>, <span class="st">"Carbothioic_acid"</span>, <span class="st">"Carbodithioic_acid"</span>,</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cations</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Primary_aliph_amine"</span>, <span class="st">"Secondary_aliph_amine"</span>, <span class="st">"Tertiary_aliph_amine"</span>, </span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Quaternary_aliph_ammonium"</span>, <span class="st">"Primary_arom_amine"</span>, <span class="st">"Secondary_arom_amine"</span>, </span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Tertiary_arom_amine"</span>, <span class="st">"Quaternary_arom_ammonium"</span>, <span class="st">"Secondary_mixed_amine"</span>, </span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Tertiary_mixed_amine"</span>, <span class="st">"Quaternary_mixed_ammonium"</span>, <span class="st">"Oxonium"</span>, </span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Immonium"</span>, <span class="st">"Sulfonium"</span>, <span class="st">"Phosphonium"</span>, <span class="st">"Hetero_N_basic_H"</span>, <span class="st">"Hetero_N_basic_no_H"</span>, <span class="st">"Amidine"</span>, <span class="st">"Guanidine"</span>, <span class="st">"Hydrazine"</span>, <span class="st">"Hydroxylamine"</span>, </span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Diazonium"</span>, <span class="st">"N-Oxide"</span></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="prepare-data" class="level2">
<h2 class="anchored" data-anchor-id="prepare-data">Prepare data</h2>
<div class="cell" data-hash="model-development-005_cache/html/prepare-ACDLabs-data_7c267b1df3f92069e0521264efeabb40">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>data<span class="ot">&lt;-</span>data <span class="sc">%&gt;%</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(analytes_names) <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mm_group =</span><span class="fu">case_when</span>(</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>             MW_ACD <span class="sc">&lt;</span> <span class="dv">200</span> <span class="sc">~</span> <span class="st">"MM &lt; 200"</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>             MW_ACD <span class="sc">&lt;</span> <span class="dv">300</span> <span class="sc">&amp;</span> MW_ACD <span class="sc">&gt;=</span> <span class="dv">200</span> <span class="sc">~</span> <span class="st">"200 \u2264 MM &lt; 300"</span>,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>             MW_ACD <span class="sc">&lt;</span> <span class="dv">400</span> <span class="sc">&amp;</span> MW_ACD <span class="sc">&gt;=</span> <span class="dv">300</span> <span class="sc">~</span> <span class="st">"300 \u2264 MM &lt; 400"</span>,</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">.default =</span> <span class="st">"400 \u2264 MM"</span>))</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>functional_groups <span class="ot">=</span> fg_df <span class="sc">%&gt;%</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">where</span>(<span class="sc">~</span> <span class="fu">is.character</span>(.) <span class="sc">||</span> <span class="sc">!</span><span class="fu">all</span>(. <span class="sc">==</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(id1,id2, SMILES, Anion, Kation, Ammonium))</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>functional_groups_names<span class="ot">&lt;-</span> <span class="fu">colnames</span>(functional_groups)</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>totalnrgroups <span class="ot">&lt;-</span> <span class="fu">summarise_each</span>(functional_groups, <span class="fu">funs</span>(sum))</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>dissociation <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="at">pKaslit =</span> data_ACD[,<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>],           <span class="co"># pKa values as predicted by ACD</span></span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a><span class="at">pKasliterror =</span> data_ACD[,<span class="dv">17</span><span class="sc">:</span><span class="dv">19</span>],    <span class="co"># pKa error as predicted by ACD</span></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a><span class="at">chargesA =</span> <span class="fu">abs</span>(data_ACD[,<span class="dv">9</span><span class="sc">:</span><span class="dv">12</span>]),    <span class="co"># number of ionized groups (anions)</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a><span class="at">chargesB =</span> <span class="fu">abs</span>(data_ACD[,<span class="dv">13</span><span class="sc">:</span><span class="dv">16</span>]))   <span class="co"># number of ionized groups (cations)</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>charges <span class="ot">=</span> dissociation<span class="sc">$</span>chargesA<span class="sc">+</span>dissociation<span class="sc">$</span>chargesB                  <span class="co"># absolute charge</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>groupsA <span class="ot">=</span> (dissociation<span class="sc">$</span>chargesA[,<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]<span class="sc">-</span>dissociation<span class="sc">$</span>chargesA[,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])         <span class="co"># acidic group</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>groupsB <span class="ot">=</span> <span class="sc">-</span>(dissociation<span class="sc">$</span>chargesB[,<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]<span class="sc">-</span>dissociation<span class="sc">$</span>chargesB[,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])        <span class="co"># basic group</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>R <span class="ot">=</span> <span class="fu">rowSums</span>(data_ACD[,<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>]<span class="sc">&lt;</span><span class="dv">14</span>) <span class="co"># number of dissociation steps</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>groups <span class="ot">=</span> dissociation<span class="sc">$</span>groupsB<span class="sc">-</span>dissociation<span class="sc">$</span>groupsA</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>logPobs <span class="ot">=</span>data_ACD<span class="sc">$</span>logP</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>MW <span class="ot">=</span>data_ACD<span class="sc">$</span>MW</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a><span class="co"># identify acidic groups</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>idxGroupsA <span class="ot">&lt;-</span><span class="fu">which</span>(dissociation<span class="sc">$</span>groupsA<span class="sc">!=</span><span class="dv">0</span>,<span class="at">arr.ind =</span> T)</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>nGroupsA <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dissociation<span class="sc">$</span>idxGroupsA)</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>pKaslitA<span class="ot">&lt;-</span>dissociation<span class="sc">$</span>pKaslit[dissociation<span class="sc">$</span>idxGroupsA]</span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a><span class="co"># identify basic groups</span></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>idxGroupsB <span class="ot">&lt;-</span><span class="fu">which</span>(dissociation<span class="sc">$</span>groupsB<span class="sc">!=</span><span class="dv">0</span>,<span class="at">arr.ind =</span> T)</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>nGroupsB <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dissociation<span class="sc">$</span>idxGroupsB)</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>pKaslitB<span class="ot">&lt;-</span>dissociation<span class="sc">$</span>pKaslit[dissociation<span class="sc">$</span>idxGroupsB]</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a><span class="co"># groups dissociated in the whole pH range</span></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>chargesA0 <span class="ot">&lt;-</span> dissociation<span class="sc">$</span>chargesA[,<span class="dv">1</span>]</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>chargesB0 <span class="ot">&lt;-</span> dissociation<span class="sc">$</span>chargesB[,<span class="fu">max</span>(dissociation<span class="sc">$</span>R)]</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>idxA0 <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">which</span>(dissociation<span class="sc">$</span>chargesA0<span class="sc">==</span><span class="dv">1</span>), <span class="fu">which</span>(dissociation<span class="sc">$</span>chargesA0<span class="sc">==</span><span class="dv">2</span>))</span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>idxB0 <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">which</span>(dissociation<span class="sc">$</span>chargesB0<span class="sc">==</span><span class="dv">1</span>), <span class="fu">which</span>(dissociation<span class="sc">$</span>chargesB0<span class="sc">==</span><span class="dv">2</span>))</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>nA0 <span class="ot">&lt;-</span> <span class="fu">length</span>(dissociation<span class="sc">$</span>idxA0)</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>nB0 <span class="ot">&lt;-</span> <span class="fu">length</span>(dissociation<span class="sc">$</span>idxB0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="initial-estimates" class="level2">
<h2 class="anchored" data-anchor-id="initial-estimates">Initial estimates</h2>
<div class="cell" data-hash="model-development-005_cache/html/initial-estimates_117c41fcdc0923d1d4826e9b36ced7fe">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>init_aprox <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ID) <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">S1 =</span> <span class="fu">if_else</span>(<span class="fu">n</span>() <span class="sc">==</span> <span class="dv">1</span>,<span class="sc">-</span><span class="dv">16</span>,<span class="fu">polyfit</span>(fi <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> fi), logk, <span class="dv">1</span>)[<span class="dv">1</span>]),</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">logkw =</span> <span class="fu">if_else</span>(<span class="fu">n</span>() <span class="sc">==</span> <span class="dv">1</span>,<span class="fu">polyfit</span>(<span class="sc">-</span><span class="dv">16</span> <span class="sc">*</span> fi <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> fi), logk, <span class="dv">0</span>), </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">polyfit</span>(fi <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> fi), logk, <span class="dv">1</span>)[<span class="dv">2</span>]),</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">S2 =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(logkw, S2, S1) <span class="sc">%&gt;%</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">S1 =</span> <span class="sc">-</span>S1 <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="data-analysis" class="level1">
<h1>Data analysis</h1>
<section id="model" class="level2">
<h2 class="anchored" data-anchor-id="model">Model</h2>
<p>The data was analyzed using a the following model:</p>
<p><span class="math display">\[
\begin{aligned}
&amp; logk_{i,j}  = logkw_{i} - S_{1,i} \cdot (1 + S_{2}) \cdot \varphi_{i,j} / (1 + S_{2} \cdot \varphi_{i,j})
\end{aligned}
\]</span></p>
<p>The statistical model has the following structure (hierarchical model):</p>
<p><span class="math display">\[
\begin{aligned}
&amp; \log k_{obs_{i,j}} \sim student_t(\nu_{obs},logk_{i,j},\sigma) \\
&amp; R_{i} \sim \text{MN}(\theta_R  + \beta \cdot log P_i +\pi_R \cdot X_i , K, \Omega_\nu) \\
&amp; \Omega_{\nu} \sim IW(\Omega,\nu) \\
&amp; \pi_{R,k} \sim N(0,\kappa_R)
\end{aligned}
\]</span> where <span class="math inline">\(R_i=(logkw_{i}, S_{1,i})\)</span> is a vector of subject-specific parameters, <span class="math inline">\(logk_{i,j}\)</span> corresponds to the above Neue equation, <span class="math inline">\(MN\)</span> is a matrix normal distribution, <span class="math inline">\(\theta_R\)</span> is a vector of typical values of <span class="math inline">\(R_i\)</span>, <span class="math inline">\(\beta_R\)</span> is a vector of slopes between <span class="math inline">\(R_i\)</span> and <span class="math inline">\(logP_i\)</span>, and <span class="math inline">\(\pi_R\)</span> is a vector of slopes between <span class="math inline">\(R_i\)</span> and functional group vector <span class="math inline">\(Xi\)</span>. In turn, <span class="math inline">\(\sigma\)</span> is the scale of the residuals, <span class="math inline">\(K\)</span> and <span class="math inline">\(\Omega\)</span> are the scale matrix for unexplained between-analyte variabilities <span class="math inline">\(\Omega\)</span> and <span class="math inline">\(K\)</span> were decomposed to:</p>
<p><span class="math display">\[
\begin{aligned}
\Omega_1 = diag(\omega) \cdot LL' \cdot diag(\omega) \\
K = S* \alpha + (1-\alpha)*I \\
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(LL'\)</span> denotes correlation a correlation matrix, <span class="math inline">\(\omega\)</span> denotes standard deviation for between analyte variability, S is a similarity matrix and I is an Identify matrix.</p>
</section>
<section id="priors" class="level2">
<h2 class="anchored" data-anchor-id="priors">Priors</h2>
<p>The priors were specified as follows:</p>
<p><span class="math display">\[
\begin{aligned}
&amp; \theta_{logkw} \sim normal(2, 4), \\
&amp; \theta_{S1} \sim normal(4, 2), \\
&amp; \theta_{S2} \sim lognormal(0.693, 0.125), \\
&amp; \nu_{obs} = 7,\\
&amp; \omega_{logkw},\omega_{S1} \sim normal_+(0, 1), \\
&amp; \beta_{logkw} \sim  normal(0.7, 0.125), \\
&amp; \beta_{S1} \sim  normal(0.5, 0.125), \\
&amp; \kappa_{logkw},\kappa_{S1} \sim  normal(0, 0.1), \\
&amp; \sigma \sim normal_+(0,0.05), \\
&amp; \alpha \sim normal(0.5,0.25)T[0,1], \\
&amp; \nu_{obs} \sim gamma(2,0.1), \\
&amp; p(LL') \propto LKJ(2) \cdot \Pi_u N(c_u, 0.125), \\
&amp; c_u = [0.75]
\end{aligned}
\]</span></p>
<p>LKJ(2) ensure that the density is uniform over correlation matrices of order 2 and u denotes the unique lower triangular elements of correlation matrix (<a href="http://srmart.in/informative-priors-for-correlation-matrices-an-easy-approach/" class="uri">http://srmart.in/informative-priors-for-correlation-matrices-an-easy-approach/</a>)</p>
</section>
</section>
<section id="stan" class="level1">
<h1>Stan</h1>
<p>Multilevel modeling was performed in <a href="https://mc-stan.org/">Stan software</a> linked with R/ <a href="https://mc-stan.org/cmdstanr/">cmdstanr</a>. For the inference we used 500 iterations, 1000 warmup iterations, and 8 Markov chains. The reduce_sum function was selected to accelerate the calculations. It works by parallelizing the execution of a single Stan chain across multiple cores. Convergence diagnostics were checked using Gelman−Rubin statistics and trace plots.</p>
<section id="initialize-variables-and-parameters" class="level3">
<h3 class="anchored" data-anchor-id="initialize-variables-and-parameters">Initialize variables and parameters</h3>
<div class="cell" data-hash="model-development-005_cache/html/stan-setup_66a43ce31441f51e5dc7ac9e2e78a069">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create Stan data set: data</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>nObs <span class="ot">&lt;-</span> <span class="fu">length</span>(data<span class="sc">$</span>ID)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>nAnalytes <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(data<span class="sc">$</span>ID))</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span>nObs)[<span class="sc">!</span><span class="fu">duplicated</span>(data<span class="sc">$</span>ID)]</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>end <span class="ot">&lt;-</span> <span class="fu">c</span>(start[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">-</span> <span class="dv">1</span>, nObs)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>nK <span class="ot">=</span> <span class="fu">ncol</span>(functional_groups)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>idx_diss <span class="ot">=</span> <span class="fu">which</span>(functional_groups_names <span class="sc">%in%</span> dissociated_groups)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>idx_nondiss <span class="ot">=</span> <span class="fu">which</span>(functional_groups_names <span class="sc">%notin%</span> dissociated_groups)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>similarity_matrix_corrected <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(Matrix<span class="sc">::</span><span class="fu">nearPD</span>(similarity_matrix, <span class="at">corr =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>mat)</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>similarity_ltri_rcdk_subset<span class="ot">&lt;-</span><span class="fu">similarity_to_ltr_fun</span>(similarity_matrix_corrected) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(similarity<span class="sc">&gt;=</span><span class="fl">0.5</span>, row<span class="sc">!=</span>col)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>uid <span class="ot">=</span> <span class="fu">unique</span>(<span class="fu">c</span>(similarity_ltri_rcdk_subset<span class="sc">$</span>row,similarity_ltri_rcdk_subset<span class="sc">$</span>col))</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> uid,<span class="at">label =</span> <span class="fu">paste</span>(uid))</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">from =</span> similarity_ltri_rcdk_subset<span class="sc">$</span>row,</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>                    <span class="at">to =</span> similarity_ltri_rcdk_subset<span class="sc">$</span>col, </span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>                    <span class="at">width =</span> similarity_ltri_rcdk_subset<span class="sc">$</span>similarity,</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label =</span> <span class="fu">paste</span>(<span class="fu">round</span>(similarity_ltri_rcdk_subset<span class="sc">$</span>similarity,<span class="dv">2</span>)))</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">graph_from_data_frame</span>(<span class="at">d =</span> edges, <span class="at">vertices =</span> nodes, <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>nodes<span class="sc">$</span>group <span class="ot">=</span> <span class="fu">cluster_louvain</span>(g)<span class="sc">$</span>membership</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">&lt;-</span> nodes <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(id)</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>idx_corelatted <span class="ot">=</span> <span class="fu">unique</span>(nodes<span class="sc">$</span>id)</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>idx_uncorelatted <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">unique</span>(similarity_ltri_rcdk_df<span class="sc">$</span>row), idx_corelatted)</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>group <span class="ot">=</span> nodes<span class="sc">$</span>group</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to data frame for manipulation</span></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> nodes</span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a><span class="cf">repeat</span> {</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>  group_sizes <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">count</span>(group, <span class="at">name =</span> <span class="st">"size"</span>)</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(group_sizes<span class="sc">$</span>size <span class="sc">&gt;=</span> <span class="dv">45</span>)) <span class="cf">break</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>  smallest <span class="ot">&lt;-</span> group_sizes <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(size) <span class="sc">%&gt;%</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>  from <span class="ot">&lt;-</span> smallest<span class="sc">$</span>group[<span class="dv">2</span>]</span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>  to <span class="ot">&lt;-</span> smallest<span class="sc">$</span>group[<span class="dv">1</span>]</span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>group[df<span class="sc">$</span>group <span class="sc">==</span> from] <span class="ot">&lt;-</span> to</span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a>nodes<span class="sc">$</span>group_combined <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(df<span class="sc">$</span>group))</span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a><span class="fu">tabulate</span>(nodes<span class="sc">$</span>group_combined)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 111  52  64  61  50  87  65  68  80  47</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(similarity_matrix_corrected)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>group_membership <span class="ot">&lt;-</span> <span class="fu">setNames</span>(nodes<span class="sc">$</span>group, nodes<span class="sc">$</span>id)  <span class="co"># id should be numeric</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>group_vec <span class="ot">&lt;-</span> group_membership[<span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span>n)]  <span class="co"># Ensure names match</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>same_group_mask <span class="ot">&lt;-</span> <span class="fu">outer</span>(group_vec, group_vec, <span class="st">`</span><span class="at">==</span><span class="st">`</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply mask to similarity matrix</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>sim_mat_masked <span class="ot">&lt;-</span> similarity_matrix_corrected <span class="sc">*</span> same_group_mask</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>sim_mat_masked[<span class="fu">is.na</span>(sim_mat_masked)]<span class="ot">=</span><span class="fl">0.0</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(sim_mat_masked)<span class="ot">&lt;-</span><span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span>n)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(sim_mat_masked)<span class="ot">&lt;-</span><span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span>n)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>datastruct <span class="ot">&lt;-</span> <span class="fu">with</span>(data,</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">list</span>(<span class="at">nAnalytes=</span><span class="fu">length</span>(<span class="fu">unique</span>(data<span class="sc">$</span>ID)),</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nAnalytes_corr=</span><span class="fu">length</span>(idx_corelatted),</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nAnalytes_uncorr=</span><span class="fu">length</span>(idx_uncorelatted),</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">idx_corr =</span> idx_corelatted,</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>                       <span class="at">idx_uncorr =</span> idx_uncorelatted,</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nfg_diss =</span> <span class="fu">length</span>(idx_diss),</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nfg_nondiss =</span> <span class="fu">length</span>(idx_nondiss),</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>                       <span class="at">idx_diss =</span> idx_diss,</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>                       <span class="at">idx_nondiss =</span> idx_nondiss,</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nObs=</span><span class="fu">length</span>(data<span class="sc">$</span>ID),</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>                       <span class="at">analyte=</span><span class="fu">match</span>(data<span class="sc">$</span>ID, <span class="fu">unique</span>(data<span class="sc">$</span>ID)),</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fi=</span>data<span class="sc">$</span>fi,</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>                       <span class="at">logPobs=</span>descriptor_df<span class="sc">$</span>LogP,</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nK =</span> nK,</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fgrp =</span> functional_groups,</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>                       <span class="at">similarity_x =</span> sim_mat_masked,</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>                       <span class="at">start =</span> start,</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>                       <span class="at">end=</span> end,</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>                       <span class="at">logkobs=</span>logk,</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>                       <span class="at">group =</span> nodes<span class="sc">$</span>group_combined,</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>                       <span class="at">mGroup =</span> <span class="fu">length</span>(<span class="fu">unique</span>(nodes<span class="sc">$</span>group_combined)),</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>                       <span class="at">run_estimation=</span><span class="dv">1</span>))</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize the values for each variable in each chain:</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>init <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(   <span class="at">logkwHat  =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>          <span class="at">S1Hat    =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">1</span>),</span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>          <span class="at">dlogkwHat  =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="fl">0.5</span>),</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>          <span class="at">dS1Hat    =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>          <span class="at">S2Hat =</span> <span class="dv">2</span><span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.125</span>)),</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>          <span class="at">beta  =</span> <span class="fu">rnorm</span>(<span class="dv">2</span>,<span class="fu">c</span>(<span class="fl">0.7</span>,<span class="fl">0.5</span>),<span class="fu">c</span>(<span class="fl">0.125</span>,<span class="fl">0.5</span>)),</span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>          <span class="at">omega =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="fl">0.5</span>)),</span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>          <span class="at">rho =</span>  <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">0.75</span>,<span class="fl">0.75</span>,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>),</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>          <span class="at">L_Omega_W =</span> <span class="fu">t</span>(<span class="fu">chol</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">0.75</span>,<span class="fl">0.75</span>,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>))),</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>          <span class="at">param_corr =</span> <span class="fu">cbind</span>(init_aprox<span class="sc">$</span>logkw[idx_corelatted],init_aprox<span class="sc">$</span>S1[idx_corelatted]),</span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>          <span class="at">param_uncorr =</span> <span class="fu">cbind</span>(init_aprox<span class="sc">$</span>logkw[idx_uncorelatted],init_aprox<span class="sc">$</span>S1[idx_uncorelatted]),</span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>          <span class="at">pilogkw =</span> <span class="fu">rep</span>(<span class="dv">0</span>,nK),</span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>          <span class="at">nu =</span> <span class="fu">max</span>(<span class="fl">3.1</span>,<span class="fu">rgamma</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="fl">0.1</span>)),</span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>          <span class="at">piS1 =</span> <span class="fu">rep</span>(<span class="dv">0</span>,nK),</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">sdpi =</span> <span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>)<span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">4</span>,<span class="dv">0</span>,<span class="fl">0.1</span>)),</span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>          <span class="at">sigma  =</span>  <span class="fl">0.05</span><span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.5</span>))</span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fitting-the-model" class="level3">
<h3 class="anchored" data-anchor-id="fitting-the-model">Fitting the model</h3>
<p>We compiled the model using cmdstanr:</p>
<div class="cell" data-hash="model-development-005_cache/html/mod-settings_5406f7886544d28b72a2cf4ea87080c3">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>model_name <span class="ot">&lt;-</span> <span class="st">"mod5"</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>model_name_ext <span class="ot">&lt;-</span> <span class="fu">paste0</span>(model_name,<span class="st">".stan"</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' folder shortcuts:</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>mod_figures_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"deliv"</span>, <span class="st">"figures"</span>, model_name)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>mod_tabels_dir  <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"deliv"</span>, <span class="st">"tables"</span>, model_name)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>mod_model_dir   <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"model"</span>, <span class="st">"stan"</span>, model_name)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>mod_output_dir   <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"model"</span>, <span class="st">"stan"</span>, model_name, <span class="st">"output"</span>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(mod_figures_dir)) <span class="fu">dir.create</span>(mod_figures_dir)</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(mod_tabels_dir)) <span class="fu">dir.create</span>(mod_tabels_dir)</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(mod_model_dir)) <span class="fu">dir.create</span>(mod_model_dir)</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(mod_output_dir)) <span class="fu">dir.create</span>(mod_output_dir)</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>modelqg_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(model_name,<span class="st">"gq"</span>)</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>modelqg_name_ext <span class="ot">&lt;-</span> <span class="fu">paste0</span>(modelqg_name,<span class="st">".stan"</span>)</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>modgq_model_dir   <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"model"</span>, <span class="st">"stan"</span>, modelqg_name)</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>modgq_output_dir   <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"model"</span>, <span class="st">"stan"</span>, modelqg_name, <span class="st">"output"</span>)</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(modgq_model_dir)) <span class="fu">dir.create</span>(modgq_model_dir)</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(modgq_output_dir)) <span class="fu">dir.create</span>(modgq_output_dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="model-development-005_cache/html/stan-compile_9ee7aa5b19a411b3c99b1c2246a56b3b">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>mod5 <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(here<span class="sc">::</span><span class="fu">here</span>(mod_model_dir, model_name_ext), <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">"O1"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We used optimization for initial testing:</p>
<div class="cell" data-hash="model-development-005_cache/html/stan-optimize_df579ea9dfeddc558c40396bcfa7baa2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>fit_opt <span class="ot">&lt;-</span> mod5<span class="sc">$</span><span class="fu">optimize</span>(</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> datastruct,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_dir =</span> mod_output_dir,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_basename =</span> <span class="st">"mod5-opt"</span>,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">init =</span> init,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter=</span><span class="dv">3000</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>fit_opt<span class="sc">$</span><span class="fu">print</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"S1Hat"</span>,<span class="st">"dlogkwHat"</span>,<span class="st">"dS1Hat"</span>,<span class="st">"beta"</span>,<span class="st">"S2Hat"</span>,<span class="st">"omega"</span>,<span class="st">"rho[1,2]"</span>,<span class="st">"sigma"</span>,<span class="st">"sdpi"</span>), <span class="at">max_rows=</span><span class="dv">13</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>For local computations one can use cmdstanr:</p>
<div class="cell" data-hash="model-development-005_cache/html/stan-sample_713009afa65549619c05ca445ecbf354">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a> fit <span class="ot">&lt;-</span> mod5<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">data =</span> datastruct,</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">output_dir =</span> mod_output_dir,</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">output_basename =</span> <span class="st">"mod5"</span>,</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">init =</span> init,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">iter_sampling =</span> <span class="dv">500</span>,</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>   <span class="at">chains =</span> <span class="dv">8</span>,</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>   <span class="at">parallel_chains =</span> <span class="dv">8</span>,</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>   <span class="at">refresh =</span> <span class="dv">100</span>,</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>   <span class="at">adapt_delta=</span><span class="fl">0.9</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We performed out computations at the Academic Computer Center in Gdańsk, <a href="https://docs.task.gda.pl/kdm/zasoby-sprzetowe/tryton/">Tryton Cluster</a>. In this case:</p>
<ol type="1">
<li>we dumped the necessary data to .json format</li>
</ol>
<div class="cell" data-hash="model-development-005_cache/html/dump-files_7a1a01b5127154d08c0bb8cdd247a453">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(datastruct, <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/standata.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-1.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-2.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-3.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-4.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-5.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-6.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-7.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-8.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="2" type="1">
<li>we run the model using the batch file:</li>
</ol>
<pre> 
</pre>
<ol start="3" type="1">
<li>After calculations, we loaded the output files using cmdstanr.</li>
</ol>
<div class="cell" data-hash="model-development-005_cache/html/stan-load_78e3024dfe72844386ef249d6b121b19">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as_cmdstan_fit</span>(<span class="fu">c</span>(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-1.csv"</span>),</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-2.csv"</span>),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-3.csv"</span>),</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-4.csv"</span>),</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-5.csv"</span>),</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-6.csv"</span>),</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-7.csv"</span>),</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-8.csv"</span>)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>                                ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<ol start="4" type="1">
<li>finally we checked the diagnostics of Monte Carlo inferences based on the Stan documentation described herein <a href="https://mc-stan.org/docs/cmdstan-guide/diagnose.html">diagnose</a></li>
</ol>
<div class="cell" data-hash="model-development-005_cache/html/stan-diagnose_1f4643bd14f536b2d869929e3d8d0496">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a> <span class="co">#fit$cmdstan_diagnose()</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">setwd</span>(mod_output_dir)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a> str <span class="ot">=</span> <span class="fu">paste0</span>(<span class="fu">cmdstan_path</span>(), <span class="st">'/bin/diagnose  mod5-*.csv'</span>)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a> <span class="fu">system</span>(str,<span class="at">intern=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The diagnostics are reasonable given model complexity. Output copied here to save time:</p>
<pre></pre>
</section>
<section id="summary-of-model-parameters-table" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-model-parameters-table">Summary of model parameters (table):</h2>
<p>The <a href="https://mc-stan.org/docs/cmdstan-guide/stansummary.html">stansummary</a> function was used to report summary and diagnostic statistics over model parameters.</p>
<div class="cell" data-hash="model-development-005_cache/html/summary_a91df866219492a3a88d53a6d532707c">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">$</span><span class="fu">print</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"S1Hat"</span>,<span class="st">"dlogkwHat"</span>,<span class="st">"dS1Hat"</span>, <span class="st">"beta"</span>,<span class="st">"S2Hat"</span>,<span class="st">"omega"</span>,<span class="st">"rho[1,2]"</span>,<span class="st">"sigma"</span>,<span class="st">"sdpi"</span>, <span class="st">"nu"</span>), <span class="at">max_rows=</span><span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  variable  mean median   sd  mad    q5   q95 rhat ess_bulk ess_tail
 logkwHat   2.69   2.69 0.18 0.18  2.40  2.98 1.00     2378     3371
 S1Hat      3.32   3.32 0.16 0.16  3.06  3.57 1.00     2390     3422
 dlogkwHat -0.38  -0.38 0.12 0.11 -0.57 -0.19 1.00     3205     3365
 dS1Hat     0.32   0.32 0.09 0.09  0.18  0.47 1.00     2592     3289
 beta[1]    0.84   0.84 0.05 0.05  0.75  0.92 1.00     2110     2903
 beta[2]    0.60   0.60 0.05 0.05  0.52  0.68 1.00     2005     3032
 S2Hat      2.89   2.89 0.03 0.04  2.84  2.95 1.01      371      866
 omega[1]   1.04   1.04 0.07 0.07  0.94  1.15 1.00     3840     3408
 omega[2]   0.92   0.92 0.06 0.06  0.83  1.02 1.00     3737     3107
 rho[1,2]   0.87   0.88 0.02 0.02  0.84  0.90 1.00     4114     3152
 sigma      0.05   0.05 0.00 0.00  0.05  0.05 1.00     2050     2111
 sdpi[1]    0.16   0.16 0.02 0.02  0.13  0.20 1.01      804     1656
 sdpi[2]    0.17   0.16 0.02 0.02  0.13  0.20 1.01      984     1923
 sdpi[3]    0.31   0.31 0.05 0.05  0.23  0.41 1.00     3592     3180
 sdpi[4]    0.21   0.20 0.05 0.05  0.13  0.30 1.00     1567     2343

 # showing 15 of 16 rows (change via 'max_rows' argument or 'cmdstanr_max_rows' option)</code></pre>
</div>
</div>
</section>
<section id="trace-plots" class="level2">
<h2 class="anchored" data-anchor-id="trace-plots">Trace plots</h2>
<p>Trace plots are time series plots of Markov chains. Here we show standard trace plots for several parameters</p>
<div class="cell" data-hash="model-development-005_cache/html/trace-plots_0a74dcaa3f2c38d18af2695d4f8ca8f2">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_trace</span>(fit<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"S1Hat"</span>,<span class="st">"beta"</span>,<span class="st">"S2Hat"</span>))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="model-development-005_files/figure-html/trace-plots-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_trace</span>(fit<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"omega"</span>,<span class="st">"rho[1,2]"</span>,<span class="st">"sigma"</span>,<span class="st">"sdpi"</span>))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="model-development-005_files/figure-html/trace-plots-2.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
</section>
<section id="summary-of-model-parameters-figures" class="level2">
<h2 class="anchored" data-anchor-id="summary-of-model-parameters-figures">Summary of model parameters (figures)</h2>
<div class="cell" data-hash="model-development-005_cache/html/mcmc-intervals_2a55fd04cb1fab0a4cb4b334ada8793a">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(fit<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"S1Hat"</span>,<span class="st">"beta"</span>,<span class="st">"S2Hat"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="model-development-005_files/figure-html/mcmc-intervals-1.png" class="img-fluid" style="width:95.0%"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(fit<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"omega"</span>,<span class="st">"sigma"</span>,<span class="st">"sdpi"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="model-development-005_files/figure-html/mcmc-intervals-2.png" class="img-fluid" style="width:95.0%"></p>
</div>
</div>
</section>
</section>
<section id="session-info" class="level1">
<h1>Session info</h1>
<div class="cell" data-hash="model-development-005_cache/html/unnamed-chunk-1_7378d0662ec2b522a2db8657fe280206">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16 ucrt)
Platform: x86_64-w64-mingw32/x64 (64-bit)
Running under: Windows 10 x64 (build 19045)

Matrix products: default


locale:
[1] LC_COLLATE=Polish_Poland.utf8  LC_CTYPE=Polish_Poland.utf8   
[3] LC_MONETARY=Polish_Poland.utf8 LC_NUMERIC=C                  
[5] LC_TIME=Polish_Poland.utf8    

time zone: Europe/Warsaw
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] ggcorrplot_0.1.4.1  ggraph_2.2.1        igraph_2.1.4       
 [4] GGally_2.2.1        mrgmisc_0.2.2       pracma_2.4.4       
 [7] reshape2_1.4.4      tidybayes_3.0.7     bayesplot_1.11.1   
[10] posterior_1.6.0     cmdstanr_0.8.0.9000 here_1.0.1         
[13] whisker_0.4.1       glue_1.7.0          lubridate_1.9.3    
[16] forcats_1.0.0       stringr_1.5.1       purrr_1.0.2        
[19] readr_2.1.5         tidyr_1.3.1         tibble_3.2.1       
[22] tidyverse_2.0.0     data.table_1.15.4   knitr_1.46         
[25] naniar_1.1.0        gridExtra_2.3       patchwork_1.2.0    
[28] ggplot2_3.5.1       dplyr_1.1.4         bbr.bayes_0.2.0    
[31] bbr_1.10.0         

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.1     svUnit_1.0.6         viridisLite_0.4.2   
 [4] farver_2.1.2         viridis_0.6.5        fastmap_1.2.0       
 [7] tensorA_0.36.2.1     tweenr_2.0.3         digest_0.6.35       
[10] timechange_0.3.0     lifecycle_1.0.4      processx_3.8.4      
[13] magrittr_2.0.3       compiler_4.3.1       rlang_1.1.3         
[16] tools_4.3.1          utf8_1.2.4           yaml_2.3.8          
[19] labeling_0.4.3       graphlayouts_1.2.2   htmlwidgets_1.6.4   
[22] plyr_1.8.9           RColorBrewer_1.1-3   abind_1.4-8         
[25] withr_3.0.2          grid_4.3.1           polyclip_1.10-7     
[28] fansi_1.0.6          diffobj_0.3.5        colorspace_2.1-0    
[31] scales_1.3.0         MASS_7.3-60          cli_3.6.2           
[34] rmarkdown_2.27       crayon_1.5.2         ragg_1.3.2          
[37] generics_0.1.3       rstudioapi_0.16.0    tzdb_0.4.0          
[40] cachem_1.1.0         ggforce_0.4.2        matrixStats_1.3.0   
[43] vctrs_0.6.5          Matrix_1.6-5         jsonlite_1.8.8      
[46] hms_1.1.3            arrayhelpers_1.1-0   ggrepel_0.9.6       
[49] visdat_0.6.0         systemfonts_1.1.0    ggdist_3.3.2        
[52] codetools_0.2-19     ggstats_0.8.0        ps_1.7.6            
[55] distributional_0.4.0 stringi_1.8.4        gtable_0.3.5        
[58] munsell_0.5.1        pillar_1.9.0         htmltools_0.5.8.1   
[61] R6_2.5.1             textshaping_0.4.0    tidygraph_1.3.1     
[64] rprojroot_2.0.4      evaluate_1.0.3       lattice_0.21-8      
[67] backports_1.5.0      memoise_2.0.1        Rcpp_1.0.12         
[70] coda_0.19-4.1        checkmate_2.3.1      xfun_0.44           
[73] fs_1.6.4             pkgconfig_2.0.3     </code></pre>
</div>
</div>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb69" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Model 005"</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co">  - name: "Paweł Wiczling*"</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="co">    affiliations:</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="co">      - name: "Department of Biopharmaceutics and Pharmacodynamics, Medical University of Gdańsk, Gen. J. Hallera 107, 80-416 Gdańsk, Poland"</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "`r format(Sys.Date())`"</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: cosmo</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true  </span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-width: 7</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a><span class="co">    fig-height: 7</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a><span class="an">knitr:</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a><span class="co">  opts_chunk: </span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a><span class="co">    dev: "ragg_png"</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introductions</span></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>Test t-matrix distributions</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a><span class="fu"># Setup</span></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup, message=FALSE}</span></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">cache=</span><span class="cn">TRUE</span>, <span class="at">message=</span><span class="cn">FALSE</span>, <span class="at">error=</span><span class="cn">FALSE</span>, <span class="at">warning=</span><span class="cn">FALSE</span>, <span class="at">comment=</span><span class="cn">NA</span>, <span class="at">out.width=</span><span class="st">'95%'</span>)</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbr)</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbr.bayes)</span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(naniar)</span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(whisker)</span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(posterior)</span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pracma)</span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mrgmisc)</span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GGally)</span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph)</span>
<span id="cb69-53"><a href="#cb69-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggraph)</span>
<span id="cb69-54"><a href="#cb69-54" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggcorrplot)</span>
<span id="cb69-55"><a href="#cb69-55" aria-hidden="true" tabindex="-1"></a><span class="co">#remotes::install_github("metrumresearchgroup/mrgmisc")</span></span>
<span id="cb69-56"><a href="#cb69-56" aria-hidden="true" tabindex="-1"></a><span class="fu">set_cmdstan_path</span>(<span class="st">"C:/Users/GUMed/.cmdstan/cmdstan-2.36.0"</span>)</span>
<span id="cb69-57"><a href="#cb69-57" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10271998</span>) <span class="do">## not required but assures repeatable results</span></span>
<span id="cb69-58"><a href="#cb69-58" aria-hidden="true" tabindex="-1"></a>select<span class="ot">&lt;-</span>dplyr<span class="sc">::</span>select</span>
<span id="cb69-59"><a href="#cb69-59" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"helper-functions.R"</span>)</span>
<span id="cb69-60"><a href="#cb69-60" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-61"><a href="#cb69-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-62"><a href="#cb69-62" aria-hidden="true" tabindex="-1"></a><span class="in">```{r settings}</span></span>
<span id="cb69-63"><a href="#cb69-63" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">=</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>)</span>
<span id="cb69-64"><a href="#cb69-64" aria-hidden="true" tabindex="-1"></a>model_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"model"</span>,<span class="st">"stan"</span>)  </span>
<span id="cb69-65"><a href="#cb69-65" aria-hidden="true" tabindex="-1"></a>figures_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"deliv"</span>,<span class="st">"figures"</span>, <span class="st">"stan"</span>)</span>
<span id="cb69-66"><a href="#cb69-66" aria-hidden="true" tabindex="-1"></a>tables_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"deliv"</span>,<span class="st">"tables"</span>, <span class="st">"stan"</span>)</span>
<span id="cb69-67"><a href="#cb69-67" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(figures_dir)) <span class="fu">dir.create</span>(figures_dir, <span class="at">recursive =</span> T)</span>
<span id="cb69-68"><a href="#cb69-68" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(model_dir)) <span class="fu">dir.create</span>(model_dir, <span class="at">recursive =</span> T)</span>
<span id="cb69-69"><a href="#cb69-69" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(tables_dir)) <span class="fu">dir.create</span>(tables_dir, <span class="at">recursive =</span> T)</span>
<span id="cb69-70"><a href="#cb69-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-71"><a href="#cb69-71" aria-hidden="true" tabindex="-1"></a>data_deliv_dir <span class="ot">=</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>,<span class="st">"deliv"</span>)</span>
<span id="cb69-72"><a href="#cb69-72" aria-hidden="true" tabindex="-1"></a>data_derived_dir <span class="ot">=</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>,<span class="st">"derived"</span>)</span>
<span id="cb69-73"><a href="#cb69-73" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(data_deliv_dir)) <span class="fu">dir.create</span>(data_deliv_dir, <span class="at">recursive =</span> T)</span>
<span id="cb69-74"><a href="#cb69-74" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(data_derived_dir)) <span class="fu">dir.create</span>(data_derived_dir, <span class="at">recursive =</span> T)</span>
<span id="cb69-75"><a href="#cb69-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-76"><a href="#cb69-76" aria-hidden="true" tabindex="-1"></a>figures_eda_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"deliv"</span>,<span class="st">"figures"</span>, <span class="st">"stan"</span>)</span>
<span id="cb69-77"><a href="#cb69-77" aria-hidden="true" tabindex="-1"></a>tables_eda_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"deliv"</span>,<span class="st">"tables"</span>, <span class="st">"stan"</span>)</span>
<span id="cb69-78"><a href="#cb69-78" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(figures_eda_dir)) <span class="fu">dir.create</span>(figures_eda_dir, <span class="at">recursive =</span> T)</span>
<span id="cb69-79"><a href="#cb69-79" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">file.exists</span>(tables_eda_dir)) <span class="fu">dir.create</span>(tables_eda_dir, <span class="at">recursive =</span> T)</span>
<span id="cb69-80"><a href="#cb69-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-81"><a href="#cb69-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-82"><a href="#cb69-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-83"><a href="#cb69-83" aria-hidden="true" tabindex="-1"></a>We used a publicly available <span class="co">[</span><span class="ot">dataset</span><span class="co">](www.retentionprediction.org/hplc/database/)</span> that comprises the measurements of RP-HPLC retention times collected for 1026 analytes. The retention times were measured under isocratic conditions on Eclipse Plus C18 (Agilent) stationary phase with 3.5 μm particles. The experiments were conducted using a mixture of two solvents: solvent A, which was made of 0.1% formic acid in water, and solvent B, which was made of 0.1% formic acid in acetonitrile. The column temperature was set at 35\^{\circ}C. The data were collected by Boswell et al. and were used to create a method to predict retention time by Back-Calculating the Gradient.</span>
<span id="cb69-84"><a href="#cb69-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-85"><a href="#cb69-85" aria-hidden="true" tabindex="-1"></a><span class="fu">## Load data</span></span>
<span id="cb69-86"><a href="#cb69-86" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load-data, message=FALSE, warning=FALSE}</span></span>
<span id="cb69-87"><a href="#cb69-87" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(data_deliv_dir, <span class="st">"database_logk_1026.csv"</span>), <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-88"><a href="#cb69-88" aria-hidden="true" tabindex="-1"></a>analytes_names  <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(data_deliv_dir,<span class="st">"database_logk_1026_analyte_names.csv"</span>), <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-89"><a href="#cb69-89" aria-hidden="true" tabindex="-1"></a>smiles <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(data_deliv_dir,<span class="st">"smiles1026.smi"</span>), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>, <span class="at">header =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-90"><a href="#cb69-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-91"><a href="#cb69-91" aria-hidden="true" tabindex="-1"></a>data_ACD <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(data_deliv_dir,<span class="st">'ACD_pKas.csv'</span>))</span>
<span id="cb69-92"><a href="#cb69-92" aria-hidden="true" tabindex="-1"></a>data_pH <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(data_deliv_dir,<span class="st">"pH.csv"</span>),<span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-93"><a href="#cb69-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-94"><a href="#cb69-94" aria-hidden="true" tabindex="-1"></a>data_ACD<span class="sc">$</span>logP <span class="ot">=</span>data <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(ID, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(logP_ACD)</span>
<span id="cb69-95"><a href="#cb69-95" aria-hidden="true" tabindex="-1"></a>data_ACD<span class="sc">$</span>MW <span class="ot">=</span>data <span class="sc">%&gt;%</span> <span class="fu">distinct</span>(ID, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(MW_ACD)</span>
<span id="cb69-96"><a href="#cb69-96" aria-hidden="true" tabindex="-1"></a>data_ACD<span class="sc">$</span>logP[<span class="dv">526</span>] <span class="ot">=</span> <span class="fu">mean</span>(data_ACD<span class="sc">$</span>logP, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-97"><a href="#cb69-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-98"><a href="#cb69-98" aria-hidden="true" tabindex="-1"></a>fg_df <span class="ot">=</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="fu">here</span>(data_deliv_dir,<span class="st">"smarts_functional_groups.csv"</span>), <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-99"><a href="#cb69-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-100"><a href="#cb69-100" aria-hidden="true" tabindex="-1"></a>descriptor_df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="fu">here</span>(data_deliv_dir,<span class="st">"descriptor_df.csv"</span>), <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-101"><a href="#cb69-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-102"><a href="#cb69-102" aria-hidden="true" tabindex="-1"></a>similarity_ltri_rcdk_df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="fu">here</span>(data_deliv_dir,<span class="st">"similarity_ltri_rcdk.csv"</span>), <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb69-103"><a href="#cb69-103" aria-hidden="true" tabindex="-1"></a>similarity_matrix <span class="ot">&lt;-</span> <span class="fu">make_similarity_matrix_fun</span>(similarity_ltri_rcdk_df)</span>
<span id="cb69-104"><a href="#cb69-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-105"><a href="#cb69-105" aria-hidden="true" tabindex="-1"></a>smiles<span class="ot">&lt;-</span>smiles <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">ID=</span>V2,<span class="at">smiles=</span>V1) <span class="sc">%&gt;%</span> <span class="fu">select</span>(ID,smiles)</span>
<span id="cb69-106"><a href="#cb69-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-107"><a href="#cb69-107" aria-hidden="true" tabindex="-1"></a>smiles<span class="sc">$</span>smiles[<span class="dv">905</span>] <span class="ot">=</span> <span class="st">"CN(C1CCCCC1N1CCCC1)C(=O)Cc1ccc(c(c1)Cl)Cl"</span> <span class="co"># remove tartrate moiety </span></span>
<span id="cb69-108"><a href="#cb69-108" aria-hidden="true" tabindex="-1"></a>smiles<span class="sc">$</span>smiles[<span class="dv">425</span>] <span class="ot">=</span> <span class="st">"CC(Cc1ccc(cc1)OCC(=O)O)NCC(c1cccc(c1)Cl)O"</span> <span class="co"># remove Na+ and dissociation</span></span>
<span id="cb69-109"><a href="#cb69-109" aria-hidden="true" tabindex="-1"></a>smiles<span class="sc">$</span>smiles[<span class="dv">501</span>] <span class="ot">=</span> <span class="st">"c1ccc(cc1)C1(c2ccccc2)C(=O)NC(=N1)O"</span></span>
<span id="cb69-110"><a href="#cb69-110" aria-hidden="true" tabindex="-1"></a>smiles<span class="sc">$</span>smiles[<span class="dv">401</span>]<span class="ot">=</span> <span class="st">"CC(C)(C)c1c(CC(C(=O)[OH])[NH2])c(=O)[nH]o1"</span></span>
<span id="cb69-111"><a href="#cb69-111" aria-hidden="true" tabindex="-1"></a>smiles<span class="sc">$</span>smiles[<span class="dv">686</span>] <span class="ot">=</span> <span class="st">"CCCCCCCCCCCCCCCC(=O)OC(CC(=O)[OH])C[N+](C)(C)C"</span></span>
<span id="cb69-112"><a href="#cb69-112" aria-hidden="true" tabindex="-1"></a>smiles<span class="sc">$</span>smiles[<span class="dv">901</span>] <span class="ot">=</span> <span class="st">"CCOC(=Nc1c[n+](no1)N1CCOCC1)[OH]"</span></span>
<span id="cb69-113"><a href="#cb69-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-114"><a href="#cb69-114" aria-hidden="true" tabindex="-1"></a>analytes_names<span class="sc">$</span>Analyte <span class="ot">&lt;-</span> <span class="fu">iconv</span>(analytes_names<span class="sc">$</span>Analyte, <span class="at">from =</span> <span class="st">""</span>, <span class="at">to =</span> <span class="st">"UTF-8"</span>, <span class="at">sub =</span> <span class="st">"byte"</span>)</span>
<span id="cb69-115"><a href="#cb69-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-116"><a href="#cb69-116" aria-hidden="true" tabindex="-1"></a><span class="co"># dissociated groups at low pH</span></span>
<span id="cb69-117"><a href="#cb69-117" aria-hidden="true" tabindex="-1"></a>dissociated_groups <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb69-118"><a href="#cb69-118" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Anions</span></span>
<span id="cb69-119"><a href="#cb69-119" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sulfonic_acid"</span>, <span class="st">"Sulfinic_acid"</span>, <span class="st">"Sulfenic_acid"</span>, <span class="st">"Sulfuric_acid"</span>, <span class="st">"Sulfuric_monoester"</span>,</span>
<span id="cb69-120"><a href="#cb69-120" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Phosphonic_acid"</span>, <span class="st">"Phosphoric_acid"</span>, <span class="st">"Phosphoric_monoester"</span>, <span class="st">"Phosphinic_acid"</span>,</span>
<span id="cb69-121"><a href="#cb69-121" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Phosphonous_acid"</span>, <span class="st">"Phosphinous_acid"</span>, <span class="st">"Carbothioic_acid"</span>, <span class="st">"Carbodithioic_acid"</span>,</span>
<span id="cb69-122"><a href="#cb69-122" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Cations</span></span>
<span id="cb69-123"><a href="#cb69-123" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Primary_aliph_amine"</span>, <span class="st">"Secondary_aliph_amine"</span>, <span class="st">"Tertiary_aliph_amine"</span>, </span>
<span id="cb69-124"><a href="#cb69-124" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Quaternary_aliph_ammonium"</span>, <span class="st">"Primary_arom_amine"</span>, <span class="st">"Secondary_arom_amine"</span>, </span>
<span id="cb69-125"><a href="#cb69-125" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Tertiary_arom_amine"</span>, <span class="st">"Quaternary_arom_ammonium"</span>, <span class="st">"Secondary_mixed_amine"</span>, </span>
<span id="cb69-126"><a href="#cb69-126" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Tertiary_mixed_amine"</span>, <span class="st">"Quaternary_mixed_ammonium"</span>, <span class="st">"Oxonium"</span>, </span>
<span id="cb69-127"><a href="#cb69-127" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Immonium"</span>, <span class="st">"Sulfonium"</span>, <span class="st">"Phosphonium"</span>, <span class="st">"Hetero_N_basic_H"</span>, <span class="st">"Hetero_N_basic_no_H"</span>, <span class="st">"Amidine"</span>, <span class="st">"Guanidine"</span>, <span class="st">"Hydrazine"</span>, <span class="st">"Hydroxylamine"</span>, </span>
<span id="cb69-128"><a href="#cb69-128" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Diazonium"</span>, <span class="st">"N-Oxide"</span></span>
<span id="cb69-129"><a href="#cb69-129" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-130"><a href="#cb69-130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-131"><a href="#cb69-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-132"><a href="#cb69-132" aria-hidden="true" tabindex="-1"></a><span class="fu">## Prepare data</span></span>
<span id="cb69-133"><a href="#cb69-133" aria-hidden="true" tabindex="-1"></a><span class="in">```{r prepare-ACDLabs-data, message=FALSE, warning=FALSE}</span></span>
<span id="cb69-134"><a href="#cb69-134" aria-hidden="true" tabindex="-1"></a>data<span class="ot">&lt;-</span>data <span class="sc">%&gt;%</span></span>
<span id="cb69-135"><a href="#cb69-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(analytes_names) <span class="sc">%&gt;%</span></span>
<span id="cb69-136"><a href="#cb69-136" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mm_group =</span><span class="fu">case_when</span>(</span>
<span id="cb69-137"><a href="#cb69-137" aria-hidden="true" tabindex="-1"></a>             MW_ACD <span class="sc">&lt;</span> <span class="dv">200</span> <span class="sc">~</span> <span class="st">"MM &lt; 200"</span>,</span>
<span id="cb69-138"><a href="#cb69-138" aria-hidden="true" tabindex="-1"></a>             MW_ACD <span class="sc">&lt;</span> <span class="dv">300</span> <span class="sc">&amp;</span> MW_ACD <span class="sc">&gt;=</span> <span class="dv">200</span> <span class="sc">~</span> <span class="st">"200 \u2264 MM &lt; 300"</span>,</span>
<span id="cb69-139"><a href="#cb69-139" aria-hidden="true" tabindex="-1"></a>             MW_ACD <span class="sc">&lt;</span> <span class="dv">400</span> <span class="sc">&amp;</span> MW_ACD <span class="sc">&gt;=</span> <span class="dv">300</span> <span class="sc">~</span> <span class="st">"300 \u2264 MM &lt; 400"</span>,</span>
<span id="cb69-140"><a href="#cb69-140" aria-hidden="true" tabindex="-1"></a>             <span class="at">.default =</span> <span class="st">"400 \u2264 MM"</span>))</span>
<span id="cb69-141"><a href="#cb69-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-142"><a href="#cb69-142" aria-hidden="true" tabindex="-1"></a>functional_groups <span class="ot">=</span> fg_df <span class="sc">%&gt;%</span></span>
<span id="cb69-143"><a href="#cb69-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">where</span>(<span class="sc">~</span> <span class="fu">is.character</span>(.) <span class="sc">||</span> <span class="sc">!</span><span class="fu">all</span>(. <span class="sc">==</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb69-144"><a href="#cb69-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(id1,id2, SMILES, Anion, Kation, Ammonium))</span>
<span id="cb69-145"><a href="#cb69-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-146"><a href="#cb69-146" aria-hidden="true" tabindex="-1"></a>functional_groups_names<span class="ot">&lt;-</span> <span class="fu">colnames</span>(functional_groups)</span>
<span id="cb69-147"><a href="#cb69-147" aria-hidden="true" tabindex="-1"></a>totalnrgroups <span class="ot">&lt;-</span> <span class="fu">summarise_each</span>(functional_groups, <span class="fu">funs</span>(sum))</span>
<span id="cb69-148"><a href="#cb69-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-149"><a href="#cb69-149" aria-hidden="true" tabindex="-1"></a>dissociation <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb69-150"><a href="#cb69-150" aria-hidden="true" tabindex="-1"></a><span class="at">pKaslit =</span> data_ACD[,<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>],           <span class="co"># pKa values as predicted by ACD</span></span>
<span id="cb69-151"><a href="#cb69-151" aria-hidden="true" tabindex="-1"></a><span class="at">pKasliterror =</span> data_ACD[,<span class="dv">17</span><span class="sc">:</span><span class="dv">19</span>],    <span class="co"># pKa error as predicted by ACD</span></span>
<span id="cb69-152"><a href="#cb69-152" aria-hidden="true" tabindex="-1"></a><span class="at">chargesA =</span> <span class="fu">abs</span>(data_ACD[,<span class="dv">9</span><span class="sc">:</span><span class="dv">12</span>]),    <span class="co"># number of ionized groups (anions)</span></span>
<span id="cb69-153"><a href="#cb69-153" aria-hidden="true" tabindex="-1"></a><span class="at">chargesB =</span> <span class="fu">abs</span>(data_ACD[,<span class="dv">13</span><span class="sc">:</span><span class="dv">16</span>]))   <span class="co"># number of ionized groups (cations)</span></span>
<span id="cb69-154"><a href="#cb69-154" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>charges <span class="ot">=</span> dissociation<span class="sc">$</span>chargesA<span class="sc">+</span>dissociation<span class="sc">$</span>chargesB                  <span class="co"># absolute charge</span></span>
<span id="cb69-155"><a href="#cb69-155" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>groupsA <span class="ot">=</span> (dissociation<span class="sc">$</span>chargesA[,<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]<span class="sc">-</span>dissociation<span class="sc">$</span>chargesA[,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])         <span class="co"># acidic group</span></span>
<span id="cb69-156"><a href="#cb69-156" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>groupsB <span class="ot">=</span> <span class="sc">-</span>(dissociation<span class="sc">$</span>chargesB[,<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>]<span class="sc">-</span>dissociation<span class="sc">$</span>chargesB[,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])        <span class="co"># basic group</span></span>
<span id="cb69-157"><a href="#cb69-157" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>R <span class="ot">=</span> <span class="fu">rowSums</span>(data_ACD[,<span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>]<span class="sc">&lt;</span><span class="dv">14</span>) <span class="co"># number of dissociation steps</span></span>
<span id="cb69-158"><a href="#cb69-158" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>groups <span class="ot">=</span> dissociation<span class="sc">$</span>groupsB<span class="sc">-</span>dissociation<span class="sc">$</span>groupsA</span>
<span id="cb69-159"><a href="#cb69-159" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>logPobs <span class="ot">=</span>data_ACD<span class="sc">$</span>logP</span>
<span id="cb69-160"><a href="#cb69-160" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>MW <span class="ot">=</span>data_ACD<span class="sc">$</span>MW</span>
<span id="cb69-161"><a href="#cb69-161" aria-hidden="true" tabindex="-1"></a><span class="co"># identify acidic groups</span></span>
<span id="cb69-162"><a href="#cb69-162" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>idxGroupsA <span class="ot">&lt;-</span><span class="fu">which</span>(dissociation<span class="sc">$</span>groupsA<span class="sc">!=</span><span class="dv">0</span>,<span class="at">arr.ind =</span> T)</span>
<span id="cb69-163"><a href="#cb69-163" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>nGroupsA <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dissociation<span class="sc">$</span>idxGroupsA)</span>
<span id="cb69-164"><a href="#cb69-164" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>pKaslitA<span class="ot">&lt;-</span>dissociation<span class="sc">$</span>pKaslit[dissociation<span class="sc">$</span>idxGroupsA]</span>
<span id="cb69-165"><a href="#cb69-165" aria-hidden="true" tabindex="-1"></a><span class="co"># identify basic groups</span></span>
<span id="cb69-166"><a href="#cb69-166" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>idxGroupsB <span class="ot">&lt;-</span><span class="fu">which</span>(dissociation<span class="sc">$</span>groupsB<span class="sc">!=</span><span class="dv">0</span>,<span class="at">arr.ind =</span> T)</span>
<span id="cb69-167"><a href="#cb69-167" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>nGroupsB <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dissociation<span class="sc">$</span>idxGroupsB)</span>
<span id="cb69-168"><a href="#cb69-168" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>pKaslitB<span class="ot">&lt;-</span>dissociation<span class="sc">$</span>pKaslit[dissociation<span class="sc">$</span>idxGroupsB]</span>
<span id="cb69-169"><a href="#cb69-169" aria-hidden="true" tabindex="-1"></a><span class="co"># groups dissociated in the whole pH range</span></span>
<span id="cb69-170"><a href="#cb69-170" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>chargesA0 <span class="ot">&lt;-</span> dissociation<span class="sc">$</span>chargesA[,<span class="dv">1</span>]</span>
<span id="cb69-171"><a href="#cb69-171" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>chargesB0 <span class="ot">&lt;-</span> dissociation<span class="sc">$</span>chargesB[,<span class="fu">max</span>(dissociation<span class="sc">$</span>R)]</span>
<span id="cb69-172"><a href="#cb69-172" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>idxA0 <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">which</span>(dissociation<span class="sc">$</span>chargesA0<span class="sc">==</span><span class="dv">1</span>), <span class="fu">which</span>(dissociation<span class="sc">$</span>chargesA0<span class="sc">==</span><span class="dv">2</span>))</span>
<span id="cb69-173"><a href="#cb69-173" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>idxB0 <span class="ot">=</span> <span class="fu">c</span>(<span class="fu">which</span>(dissociation<span class="sc">$</span>chargesB0<span class="sc">==</span><span class="dv">1</span>), <span class="fu">which</span>(dissociation<span class="sc">$</span>chargesB0<span class="sc">==</span><span class="dv">2</span>))</span>
<span id="cb69-174"><a href="#cb69-174" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>nA0 <span class="ot">&lt;-</span> <span class="fu">length</span>(dissociation<span class="sc">$</span>idxA0)</span>
<span id="cb69-175"><a href="#cb69-175" aria-hidden="true" tabindex="-1"></a>dissociation<span class="sc">$</span>nB0 <span class="ot">&lt;-</span> <span class="fu">length</span>(dissociation<span class="sc">$</span>idxB0)</span>
<span id="cb69-176"><a href="#cb69-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-177"><a href="#cb69-177" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-178"><a href="#cb69-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-179"><a href="#cb69-179" aria-hidden="true" tabindex="-1"></a><span class="fu">## Initial estimates</span></span>
<span id="cb69-180"><a href="#cb69-180" aria-hidden="true" tabindex="-1"></a><span class="in">```{r initial-estimates}</span></span>
<span id="cb69-181"><a href="#cb69-181" aria-hidden="true" tabindex="-1"></a>init_aprox <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb69-182"><a href="#cb69-182" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ID) <span class="sc">%&gt;%</span></span>
<span id="cb69-183"><a href="#cb69-183" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb69-184"><a href="#cb69-184" aria-hidden="true" tabindex="-1"></a>    <span class="at">S1 =</span> <span class="fu">if_else</span>(<span class="fu">n</span>() <span class="sc">==</span> <span class="dv">1</span>,<span class="sc">-</span><span class="dv">16</span>,<span class="fu">polyfit</span>(fi <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> fi), logk, <span class="dv">1</span>)[<span class="dv">1</span>]),</span>
<span id="cb69-185"><a href="#cb69-185" aria-hidden="true" tabindex="-1"></a>    <span class="at">logkw =</span> <span class="fu">if_else</span>(<span class="fu">n</span>() <span class="sc">==</span> <span class="dv">1</span>,<span class="fu">polyfit</span>(<span class="sc">-</span><span class="dv">16</span> <span class="sc">*</span> fi <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> fi), logk, <span class="dv">0</span>), </span>
<span id="cb69-186"><a href="#cb69-186" aria-hidden="true" tabindex="-1"></a>                             <span class="fu">polyfit</span>(fi <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> fi), logk, <span class="dv">1</span>)[<span class="dv">2</span>]),</span>
<span id="cb69-187"><a href="#cb69-187" aria-hidden="true" tabindex="-1"></a>    <span class="at">S2 =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb69-188"><a href="#cb69-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb69-189"><a href="#cb69-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(logkw, S2, S1) <span class="sc">%&gt;%</span></span>
<span id="cb69-190"><a href="#cb69-190" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">S1 =</span> <span class="sc">-</span>S1 <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="dv">2</span>))</span>
<span id="cb69-191"><a href="#cb69-191" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-192"><a href="#cb69-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-193"><a href="#cb69-193" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data analysis</span></span>
<span id="cb69-194"><a href="#cb69-194" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model</span></span>
<span id="cb69-195"><a href="#cb69-195" aria-hidden="true" tabindex="-1"></a>The data was analyzed using a the following model:</span>
<span id="cb69-196"><a href="#cb69-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-197"><a href="#cb69-197" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-198"><a href="#cb69-198" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb69-199"><a href="#cb69-199" aria-hidden="true" tabindex="-1"></a>&amp; logk_{i,j}  = logkw_{i} - S_{1,i} \cdot (1 + S_{2}) \cdot \varphi_{i,j} / (1 + S_{2} \cdot \varphi_{i,j})</span>
<span id="cb69-200"><a href="#cb69-200" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb69-201"><a href="#cb69-201" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-202"><a href="#cb69-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-203"><a href="#cb69-203" aria-hidden="true" tabindex="-1"></a>The statistical model has the following structure (hierarchical model):</span>
<span id="cb69-204"><a href="#cb69-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-205"><a href="#cb69-205" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb69-206"><a href="#cb69-206" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb69-207"><a href="#cb69-207" aria-hidden="true" tabindex="-1"></a>&amp; \log k_{obs_{i,j}} \sim student_t(\nu_{obs},logk_{i,j},\sigma) <span class="sc">\\</span></span>
<span id="cb69-208"><a href="#cb69-208" aria-hidden="true" tabindex="-1"></a>&amp; R_{i} \sim \text{MN}(\theta_R  + \beta \cdot log P_i +\pi_R \cdot X_i , K, \Omega_\nu) <span class="sc">\\</span></span>
<span id="cb69-209"><a href="#cb69-209" aria-hidden="true" tabindex="-1"></a>&amp; \Omega_{\nu} \sim IW(\Omega,\nu) <span class="sc">\\</span></span>
<span id="cb69-210"><a href="#cb69-210" aria-hidden="true" tabindex="-1"></a>&amp; \pi_{R,k} \sim N(0,\kappa_R)</span>
<span id="cb69-211"><a href="#cb69-211" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb69-212"><a href="#cb69-212" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-213"><a href="#cb69-213" aria-hidden="true" tabindex="-1"></a>where $R_i=(logkw_{i}, S_{1,i})$ is a vector of subject-specific parameters, $logk_{i,j}$ corresponds to the above Neue equation, $MN$ is a matrix normal distribution, $\theta_R$ is a vector of typical values of $R_i$, $\beta_R$ is a vector of slopes between $R_i$ and $logP_i$, and $\pi_R$ is a vector of slopes between $R_i$ and functional group vector $Xi$. In turn, $\sigma$ is the scale of the residuals, $K$ and $\Omega$ are the scale matrix for unexplained between-analyte variabilities $\Omega$ and $K$ were decomposed to:</span>
<span id="cb69-214"><a href="#cb69-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-215"><a href="#cb69-215" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-216"><a href="#cb69-216" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb69-217"><a href="#cb69-217" aria-hidden="true" tabindex="-1"></a>\Omega_1 = diag(\omega) \cdot LL' \cdot diag(\omega) <span class="sc">\\</span></span>
<span id="cb69-218"><a href="#cb69-218" aria-hidden="true" tabindex="-1"></a>K = S* \alpha + (1-\alpha)*I <span class="sc">\\</span></span>
<span id="cb69-219"><a href="#cb69-219" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb69-220"><a href="#cb69-220" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-221"><a href="#cb69-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-222"><a href="#cb69-222" aria-hidden="true" tabindex="-1"></a>where $LL'$ denotes correlation a correlation matrix, $\omega$ denotes standard deviation for between analyte variability, S is a similarity matrix and I is an Identify matrix.</span>
<span id="cb69-223"><a href="#cb69-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-224"><a href="#cb69-224" aria-hidden="true" tabindex="-1"></a><span class="fu">## Priors</span></span>
<span id="cb69-225"><a href="#cb69-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-226"><a href="#cb69-226" aria-hidden="true" tabindex="-1"></a>The priors were specified as follows:</span>
<span id="cb69-227"><a href="#cb69-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-228"><a href="#cb69-228" aria-hidden="true" tabindex="-1"></a>$$ </span>
<span id="cb69-229"><a href="#cb69-229" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb69-230"><a href="#cb69-230" aria-hidden="true" tabindex="-1"></a>&amp; \theta_{logkw} \sim normal(2, 4), <span class="sc">\\</span></span>
<span id="cb69-231"><a href="#cb69-231" aria-hidden="true" tabindex="-1"></a>&amp; \theta_{S1} \sim normal(4, 2), <span class="sc">\\</span></span>
<span id="cb69-232"><a href="#cb69-232" aria-hidden="true" tabindex="-1"></a>&amp; \theta_{S2} \sim lognormal(0.693, 0.125), <span class="sc">\\</span></span>
<span id="cb69-233"><a href="#cb69-233" aria-hidden="true" tabindex="-1"></a>&amp; \nu_{obs} = 7,<span class="sc">\\</span></span>
<span id="cb69-234"><a href="#cb69-234" aria-hidden="true" tabindex="-1"></a>&amp; \omega_{logkw},\omega_{S1} \sim normal_+(0, 1), <span class="sc">\\</span></span>
<span id="cb69-235"><a href="#cb69-235" aria-hidden="true" tabindex="-1"></a>&amp; \beta_{logkw} \sim  normal(0.7, 0.125), <span class="sc">\\</span></span>
<span id="cb69-236"><a href="#cb69-236" aria-hidden="true" tabindex="-1"></a>&amp; \beta_{S1} \sim  normal(0.5, 0.125), <span class="sc">\\</span></span>
<span id="cb69-237"><a href="#cb69-237" aria-hidden="true" tabindex="-1"></a>&amp; \kappa_{logkw},\kappa_{S1} \sim  normal(0, 0.1), <span class="sc">\\</span></span>
<span id="cb69-238"><a href="#cb69-238" aria-hidden="true" tabindex="-1"></a>&amp; \sigma \sim normal_+(0,0.05), <span class="sc">\\</span></span>
<span id="cb69-239"><a href="#cb69-239" aria-hidden="true" tabindex="-1"></a>&amp; \alpha \sim normal(0.5,0.25)T<span class="co">[</span><span class="ot">0,1</span><span class="co">]</span>, <span class="sc">\\</span></span>
<span id="cb69-240"><a href="#cb69-240" aria-hidden="true" tabindex="-1"></a>&amp; \nu_{obs} \sim gamma(2,0.1), <span class="sc">\\</span></span>
<span id="cb69-241"><a href="#cb69-241" aria-hidden="true" tabindex="-1"></a>&amp; p(LL') \propto LKJ(2) \cdot \Pi_u N(c_u, 0.125), <span class="sc">\\</span></span>
<span id="cb69-242"><a href="#cb69-242" aria-hidden="true" tabindex="-1"></a>&amp; c_u = <span class="co">[</span><span class="ot">0.75</span><span class="co">]</span></span>
<span id="cb69-243"><a href="#cb69-243" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb69-244"><a href="#cb69-244" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb69-245"><a href="#cb69-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-246"><a href="#cb69-246" aria-hidden="true" tabindex="-1"></a>LKJ(2) ensure that the density is uniform over correlation matrices of order 2 and u denotes the unique lower triangular elements of correlation matrix (<span class="ot">&lt;http://srmart.in/informative-priors-for-correlation-matrices-an-easy-approach/&gt;</span>)</span>
<span id="cb69-247"><a href="#cb69-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-248"><a href="#cb69-248" aria-hidden="true" tabindex="-1"></a><span class="fu"># Stan</span></span>
<span id="cb69-249"><a href="#cb69-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-250"><a href="#cb69-250" aria-hidden="true" tabindex="-1"></a>Multilevel modeling was performed in <span class="co">[</span><span class="ot">Stan software</span><span class="co">](https://mc-stan.org/)</span> linked with R/ <span class="co">[</span><span class="ot">cmdstanr</span><span class="co">](https://mc-stan.org/cmdstanr/)</span>. For the inference we used 500 iterations, 1000 warmup iterations, and 8 Markov chains. The reduce_sum function was selected to accelerate the calculations. It works by parallelizing the execution of a single Stan chain across multiple cores. Convergence diagnostics were checked using Gelman−Rubin statistics and trace plots.</span>
<span id="cb69-251"><a href="#cb69-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-252"><a href="#cb69-252" aria-hidden="true" tabindex="-1"></a><span class="fu">### Initialize variables and parameters</span></span>
<span id="cb69-253"><a href="#cb69-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-254"><a href="#cb69-254" aria-hidden="true" tabindex="-1"></a><span class="in">```{r stan-setup}</span></span>
<span id="cb69-255"><a href="#cb69-255" aria-hidden="true" tabindex="-1"></a><span class="co"># create Stan data set: data</span></span>
<span id="cb69-256"><a href="#cb69-256" aria-hidden="true" tabindex="-1"></a>nObs <span class="ot">&lt;-</span> <span class="fu">length</span>(data<span class="sc">$</span>ID)</span>
<span id="cb69-257"><a href="#cb69-257" aria-hidden="true" tabindex="-1"></a>nAnalytes <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(data<span class="sc">$</span>ID))</span>
<span id="cb69-258"><a href="#cb69-258" aria-hidden="true" tabindex="-1"></a>start <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span>nObs)[<span class="sc">!</span><span class="fu">duplicated</span>(data<span class="sc">$</span>ID)]</span>
<span id="cb69-259"><a href="#cb69-259" aria-hidden="true" tabindex="-1"></a>end <span class="ot">&lt;-</span> <span class="fu">c</span>(start[<span class="sc">-</span><span class="dv">1</span>] <span class="sc">-</span> <span class="dv">1</span>, nObs)</span>
<span id="cb69-260"><a href="#cb69-260" aria-hidden="true" tabindex="-1"></a>nK <span class="ot">=</span> <span class="fu">ncol</span>(functional_groups)</span>
<span id="cb69-261"><a href="#cb69-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-262"><a href="#cb69-262" aria-hidden="true" tabindex="-1"></a>idx_diss <span class="ot">=</span> <span class="fu">which</span>(functional_groups_names <span class="sc">%in%</span> dissociated_groups)</span>
<span id="cb69-263"><a href="#cb69-263" aria-hidden="true" tabindex="-1"></a>idx_nondiss <span class="ot">=</span> <span class="fu">which</span>(functional_groups_names <span class="sc">%notin%</span> dissociated_groups)</span>
<span id="cb69-264"><a href="#cb69-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-265"><a href="#cb69-265" aria-hidden="true" tabindex="-1"></a>similarity_matrix_corrected <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(Matrix<span class="sc">::</span><span class="fu">nearPD</span>(similarity_matrix, <span class="at">corr =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>mat)</span>
<span id="cb69-266"><a href="#cb69-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-267"><a href="#cb69-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-268"><a href="#cb69-268" aria-hidden="true" tabindex="-1"></a>similarity_ltri_rcdk_subset<span class="ot">&lt;-</span><span class="fu">similarity_to_ltr_fun</span>(similarity_matrix_corrected) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(similarity<span class="sc">&gt;=</span><span class="fl">0.5</span>, row<span class="sc">!=</span>col)</span>
<span id="cb69-269"><a href="#cb69-269" aria-hidden="true" tabindex="-1"></a>uid <span class="ot">=</span> <span class="fu">unique</span>(<span class="fu">c</span>(similarity_ltri_rcdk_subset<span class="sc">$</span>row,similarity_ltri_rcdk_subset<span class="sc">$</span>col))</span>
<span id="cb69-270"><a href="#cb69-270" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">id =</span> uid,<span class="at">label =</span> <span class="fu">paste</span>(uid))</span>
<span id="cb69-271"><a href="#cb69-271" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">from =</span> similarity_ltri_rcdk_subset<span class="sc">$</span>row,</span>
<span id="cb69-272"><a href="#cb69-272" aria-hidden="true" tabindex="-1"></a>                    <span class="at">to =</span> similarity_ltri_rcdk_subset<span class="sc">$</span>col, </span>
<span id="cb69-273"><a href="#cb69-273" aria-hidden="true" tabindex="-1"></a>                    <span class="at">width =</span> similarity_ltri_rcdk_subset<span class="sc">$</span>similarity,</span>
<span id="cb69-274"><a href="#cb69-274" aria-hidden="true" tabindex="-1"></a>                    <span class="at">label =</span> <span class="fu">paste</span>(<span class="fu">round</span>(similarity_ltri_rcdk_subset<span class="sc">$</span>similarity,<span class="dv">2</span>)))</span>
<span id="cb69-275"><a href="#cb69-275" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="fu">graph_from_data_frame</span>(<span class="at">d =</span> edges, <span class="at">vertices =</span> nodes, <span class="at">directed =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-276"><a href="#cb69-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-277"><a href="#cb69-277" aria-hidden="true" tabindex="-1"></a>nodes<span class="sc">$</span>group <span class="ot">=</span> <span class="fu">cluster_louvain</span>(g)<span class="sc">$</span>membership</span>
<span id="cb69-278"><a href="#cb69-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-279"><a href="#cb69-279" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">&lt;-</span> nodes <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(id)</span>
<span id="cb69-280"><a href="#cb69-280" aria-hidden="true" tabindex="-1"></a>idx_corelatted <span class="ot">=</span> <span class="fu">unique</span>(nodes<span class="sc">$</span>id)</span>
<span id="cb69-281"><a href="#cb69-281" aria-hidden="true" tabindex="-1"></a>idx_uncorelatted <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">unique</span>(similarity_ltri_rcdk_df<span class="sc">$</span>row), idx_corelatted)</span>
<span id="cb69-282"><a href="#cb69-282" aria-hidden="true" tabindex="-1"></a>group <span class="ot">=</span> nodes<span class="sc">$</span>group</span>
<span id="cb69-283"><a href="#cb69-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-284"><a href="#cb69-284" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to data frame for manipulation</span></span>
<span id="cb69-285"><a href="#cb69-285" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> nodes</span>
<span id="cb69-286"><a href="#cb69-286" aria-hidden="true" tabindex="-1"></a><span class="cf">repeat</span> {</span>
<span id="cb69-287"><a href="#cb69-287" aria-hidden="true" tabindex="-1"></a>  group_sizes <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">count</span>(group, <span class="at">name =</span> <span class="st">"size"</span>)</span>
<span id="cb69-288"><a href="#cb69-288" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">all</span>(group_sizes<span class="sc">$</span>size <span class="sc">&gt;=</span> <span class="dv">45</span>)) <span class="cf">break</span></span>
<span id="cb69-289"><a href="#cb69-289" aria-hidden="true" tabindex="-1"></a>  smallest <span class="ot">&lt;-</span> group_sizes <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(size) <span class="sc">%&gt;%</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span>
<span id="cb69-290"><a href="#cb69-290" aria-hidden="true" tabindex="-1"></a>  from <span class="ot">&lt;-</span> smallest<span class="sc">$</span>group[<span class="dv">2</span>]</span>
<span id="cb69-291"><a href="#cb69-291" aria-hidden="true" tabindex="-1"></a>  to <span class="ot">&lt;-</span> smallest<span class="sc">$</span>group[<span class="dv">1</span>]</span>
<span id="cb69-292"><a href="#cb69-292" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>group[df<span class="sc">$</span>group <span class="sc">==</span> from] <span class="ot">&lt;-</span> to</span>
<span id="cb69-293"><a href="#cb69-293" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-294"><a href="#cb69-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-295"><a href="#cb69-295" aria-hidden="true" tabindex="-1"></a>nodes<span class="sc">$</span>group_combined <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(df<span class="sc">$</span>group))</span>
<span id="cb69-296"><a href="#cb69-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-297"><a href="#cb69-297" aria-hidden="true" tabindex="-1"></a><span class="fu">tabulate</span>(nodes<span class="sc">$</span>group_combined)</span>
<span id="cb69-298"><a href="#cb69-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-299"><a href="#cb69-299" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(similarity_matrix_corrected)</span>
<span id="cb69-300"><a href="#cb69-300" aria-hidden="true" tabindex="-1"></a>group_membership <span class="ot">&lt;-</span> <span class="fu">setNames</span>(nodes<span class="sc">$</span>group, nodes<span class="sc">$</span>id)  <span class="co"># id should be numeric</span></span>
<span id="cb69-301"><a href="#cb69-301" aria-hidden="true" tabindex="-1"></a>group_vec <span class="ot">&lt;-</span> group_membership[<span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span>n)]  <span class="co"># Ensure names match</span></span>
<span id="cb69-302"><a href="#cb69-302" aria-hidden="true" tabindex="-1"></a>same_group_mask <span class="ot">&lt;-</span> <span class="fu">outer</span>(group_vec, group_vec, <span class="st">`</span><span class="at">==</span><span class="st">`</span>)</span>
<span id="cb69-303"><a href="#cb69-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-304"><a href="#cb69-304" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply mask to similarity matrix</span></span>
<span id="cb69-305"><a href="#cb69-305" aria-hidden="true" tabindex="-1"></a>sim_mat_masked <span class="ot">&lt;-</span> similarity_matrix_corrected <span class="sc">*</span> same_group_mask</span>
<span id="cb69-306"><a href="#cb69-306" aria-hidden="true" tabindex="-1"></a>sim_mat_masked[<span class="fu">is.na</span>(sim_mat_masked)]<span class="ot">=</span><span class="fl">0.0</span></span>
<span id="cb69-307"><a href="#cb69-307" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(sim_mat_masked)<span class="ot">&lt;-</span><span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span>n)</span>
<span id="cb69-308"><a href="#cb69-308" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(sim_mat_masked)<span class="ot">&lt;-</span><span class="fu">as.character</span>(<span class="dv">1</span><span class="sc">:</span>n)</span>
<span id="cb69-309"><a href="#cb69-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-310"><a href="#cb69-310" aria-hidden="true" tabindex="-1"></a>datastruct <span class="ot">&lt;-</span> <span class="fu">with</span>(data,</span>
<span id="cb69-311"><a href="#cb69-311" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">list</span>(<span class="at">nAnalytes=</span><span class="fu">length</span>(<span class="fu">unique</span>(data<span class="sc">$</span>ID)),</span>
<span id="cb69-312"><a href="#cb69-312" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nAnalytes_corr=</span><span class="fu">length</span>(idx_corelatted),</span>
<span id="cb69-313"><a href="#cb69-313" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nAnalytes_uncorr=</span><span class="fu">length</span>(idx_uncorelatted),</span>
<span id="cb69-314"><a href="#cb69-314" aria-hidden="true" tabindex="-1"></a>                       <span class="at">idx_corr =</span> idx_corelatted,</span>
<span id="cb69-315"><a href="#cb69-315" aria-hidden="true" tabindex="-1"></a>                       <span class="at">idx_uncorr =</span> idx_uncorelatted,</span>
<span id="cb69-316"><a href="#cb69-316" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nfg_diss =</span> <span class="fu">length</span>(idx_diss),</span>
<span id="cb69-317"><a href="#cb69-317" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nfg_nondiss =</span> <span class="fu">length</span>(idx_nondiss),</span>
<span id="cb69-318"><a href="#cb69-318" aria-hidden="true" tabindex="-1"></a>                       <span class="at">idx_diss =</span> idx_diss,</span>
<span id="cb69-319"><a href="#cb69-319" aria-hidden="true" tabindex="-1"></a>                       <span class="at">idx_nondiss =</span> idx_nondiss,</span>
<span id="cb69-320"><a href="#cb69-320" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nObs=</span><span class="fu">length</span>(data<span class="sc">$</span>ID),</span>
<span id="cb69-321"><a href="#cb69-321" aria-hidden="true" tabindex="-1"></a>                       <span class="at">analyte=</span><span class="fu">match</span>(data<span class="sc">$</span>ID, <span class="fu">unique</span>(data<span class="sc">$</span>ID)),</span>
<span id="cb69-322"><a href="#cb69-322" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fi=</span>data<span class="sc">$</span>fi,</span>
<span id="cb69-323"><a href="#cb69-323" aria-hidden="true" tabindex="-1"></a>                       <span class="at">logPobs=</span>descriptor_df<span class="sc">$</span>LogP,</span>
<span id="cb69-324"><a href="#cb69-324" aria-hidden="true" tabindex="-1"></a>                       <span class="at">nK =</span> nK,</span>
<span id="cb69-325"><a href="#cb69-325" aria-hidden="true" tabindex="-1"></a>                       <span class="at">fgrp =</span> functional_groups,</span>
<span id="cb69-326"><a href="#cb69-326" aria-hidden="true" tabindex="-1"></a>                       <span class="at">similarity_x =</span> sim_mat_masked,</span>
<span id="cb69-327"><a href="#cb69-327" aria-hidden="true" tabindex="-1"></a>                       <span class="at">start =</span> start,</span>
<span id="cb69-328"><a href="#cb69-328" aria-hidden="true" tabindex="-1"></a>                       <span class="at">end=</span> end,</span>
<span id="cb69-329"><a href="#cb69-329" aria-hidden="true" tabindex="-1"></a>                       <span class="at">logkobs=</span>logk,</span>
<span id="cb69-330"><a href="#cb69-330" aria-hidden="true" tabindex="-1"></a>                       <span class="at">group =</span> nodes<span class="sc">$</span>group_combined,</span>
<span id="cb69-331"><a href="#cb69-331" aria-hidden="true" tabindex="-1"></a>                       <span class="at">mGroup =</span> <span class="fu">length</span>(<span class="fu">unique</span>(nodes<span class="sc">$</span>group_combined)),</span>
<span id="cb69-332"><a href="#cb69-332" aria-hidden="true" tabindex="-1"></a>                       <span class="at">run_estimation=</span><span class="dv">1</span>))</span>
<span id="cb69-333"><a href="#cb69-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-334"><a href="#cb69-334" aria-hidden="true" tabindex="-1"></a><span class="co"># initialize the values for each variable in each chain:</span></span>
<span id="cb69-335"><a href="#cb69-335" aria-hidden="true" tabindex="-1"></a>init <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb69-336"><a href="#cb69-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(   <span class="at">logkwHat  =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>),</span>
<span id="cb69-337"><a href="#cb69-337" aria-hidden="true" tabindex="-1"></a>          <span class="at">S1Hat    =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">1</span>),</span>
<span id="cb69-338"><a href="#cb69-338" aria-hidden="true" tabindex="-1"></a>          <span class="at">dlogkwHat  =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="fl">0.5</span>),</span>
<span id="cb69-339"><a href="#cb69-339" aria-hidden="true" tabindex="-1"></a>          <span class="at">dS1Hat    =</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.5</span>),</span>
<span id="cb69-340"><a href="#cb69-340" aria-hidden="true" tabindex="-1"></a>          <span class="at">S2Hat =</span> <span class="dv">2</span><span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="fl">0.125</span>)),</span>
<span id="cb69-341"><a href="#cb69-341" aria-hidden="true" tabindex="-1"></a>          <span class="at">beta  =</span> <span class="fu">rnorm</span>(<span class="dv">2</span>,<span class="fu">c</span>(<span class="fl">0.7</span>,<span class="fl">0.5</span>),<span class="fu">c</span>(<span class="fl">0.125</span>,<span class="fl">0.5</span>)),</span>
<span id="cb69-342"><a href="#cb69-342" aria-hidden="true" tabindex="-1"></a>          <span class="at">omega =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="fl">0.5</span>)),</span>
<span id="cb69-343"><a href="#cb69-343" aria-hidden="true" tabindex="-1"></a>          <span class="at">rho =</span>  <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">0.75</span>,<span class="fl">0.75</span>,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>),</span>
<span id="cb69-344"><a href="#cb69-344" aria-hidden="true" tabindex="-1"></a>          <span class="at">L_Omega_W =</span> <span class="fu">t</span>(<span class="fu">chol</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="fl">0.75</span>,<span class="fl">0.75</span>,<span class="dv">1</span>), <span class="at">nrow=</span><span class="dv">2</span>))),</span>
<span id="cb69-345"><a href="#cb69-345" aria-hidden="true" tabindex="-1"></a>          <span class="at">param_corr =</span> <span class="fu">cbind</span>(init_aprox<span class="sc">$</span>logkw[idx_corelatted],init_aprox<span class="sc">$</span>S1[idx_corelatted]),</span>
<span id="cb69-346"><a href="#cb69-346" aria-hidden="true" tabindex="-1"></a>          <span class="at">param_uncorr =</span> <span class="fu">cbind</span>(init_aprox<span class="sc">$</span>logkw[idx_uncorelatted],init_aprox<span class="sc">$</span>S1[idx_uncorelatted]),</span>
<span id="cb69-347"><a href="#cb69-347" aria-hidden="true" tabindex="-1"></a>          <span class="at">pilogkw =</span> <span class="fu">rep</span>(<span class="dv">0</span>,nK),</span>
<span id="cb69-348"><a href="#cb69-348" aria-hidden="true" tabindex="-1"></a>          <span class="at">nu =</span> <span class="fu">max</span>(<span class="fl">3.1</span>,<span class="fu">rgamma</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="fl">0.1</span>)),</span>
<span id="cb69-349"><a href="#cb69-349" aria-hidden="true" tabindex="-1"></a>          <span class="at">piS1 =</span> <span class="fu">rep</span>(<span class="dv">0</span>,nK),</span>
<span id="cb69-350"><a href="#cb69-350" aria-hidden="true" tabindex="-1"></a>          <span class="at">sdpi =</span> <span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>)<span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">4</span>,<span class="dv">0</span>,<span class="fl">0.1</span>)),</span>
<span id="cb69-351"><a href="#cb69-351" aria-hidden="true" tabindex="-1"></a>          <span class="at">sigma  =</span>  <span class="fl">0.05</span><span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.5</span>))</span>
<span id="cb69-352"><a href="#cb69-352" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb69-353"><a href="#cb69-353" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-354"><a href="#cb69-354" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-355"><a href="#cb69-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-356"><a href="#cb69-356" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fitting the model</span></span>
<span id="cb69-357"><a href="#cb69-357" aria-hidden="true" tabindex="-1"></a>We compiled the model using cmdstanr:</span>
<span id="cb69-358"><a href="#cb69-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mod-settings}</span></span>
<span id="cb69-359"><a href="#cb69-359" aria-hidden="true" tabindex="-1"></a>model_name <span class="ot">&lt;-</span> <span class="st">"mod5"</span></span>
<span id="cb69-360"><a href="#cb69-360" aria-hidden="true" tabindex="-1"></a>model_name_ext <span class="ot">&lt;-</span> <span class="fu">paste0</span>(model_name,<span class="st">".stan"</span>)</span>
<span id="cb69-361"><a href="#cb69-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-362"><a href="#cb69-362" aria-hidden="true" tabindex="-1"></a><span class="co">#' folder shortcuts:</span></span>
<span id="cb69-363"><a href="#cb69-363" aria-hidden="true" tabindex="-1"></a>mod_figures_dir <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"deliv"</span>, <span class="st">"figures"</span>, model_name)</span>
<span id="cb69-364"><a href="#cb69-364" aria-hidden="true" tabindex="-1"></a>mod_tabels_dir  <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"deliv"</span>, <span class="st">"tables"</span>, model_name)</span>
<span id="cb69-365"><a href="#cb69-365" aria-hidden="true" tabindex="-1"></a>mod_model_dir   <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"model"</span>, <span class="st">"stan"</span>, model_name)</span>
<span id="cb69-366"><a href="#cb69-366" aria-hidden="true" tabindex="-1"></a>mod_output_dir   <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"model"</span>, <span class="st">"stan"</span>, model_name, <span class="st">"output"</span>)</span>
<span id="cb69-367"><a href="#cb69-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-368"><a href="#cb69-368" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(mod_figures_dir)) <span class="fu">dir.create</span>(mod_figures_dir)</span>
<span id="cb69-369"><a href="#cb69-369" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(mod_tabels_dir)) <span class="fu">dir.create</span>(mod_tabels_dir)</span>
<span id="cb69-370"><a href="#cb69-370" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(mod_model_dir)) <span class="fu">dir.create</span>(mod_model_dir)</span>
<span id="cb69-371"><a href="#cb69-371" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(mod_output_dir)) <span class="fu">dir.create</span>(mod_output_dir)</span>
<span id="cb69-372"><a href="#cb69-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-373"><a href="#cb69-373" aria-hidden="true" tabindex="-1"></a>modelqg_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(model_name,<span class="st">"gq"</span>)</span>
<span id="cb69-374"><a href="#cb69-374" aria-hidden="true" tabindex="-1"></a>modelqg_name_ext <span class="ot">&lt;-</span> <span class="fu">paste0</span>(modelqg_name,<span class="st">".stan"</span>)</span>
<span id="cb69-375"><a href="#cb69-375" aria-hidden="true" tabindex="-1"></a>modgq_model_dir   <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"model"</span>, <span class="st">"stan"</span>, modelqg_name)</span>
<span id="cb69-376"><a href="#cb69-376" aria-hidden="true" tabindex="-1"></a>modgq_output_dir   <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"model"</span>, <span class="st">"stan"</span>, modelqg_name, <span class="st">"output"</span>)</span>
<span id="cb69-377"><a href="#cb69-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-378"><a href="#cb69-378" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(modgq_model_dir)) <span class="fu">dir.create</span>(modgq_model_dir)</span>
<span id="cb69-379"><a href="#cb69-379" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(modgq_output_dir)) <span class="fu">dir.create</span>(modgq_output_dir)</span>
<span id="cb69-380"><a href="#cb69-380" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-381"><a href="#cb69-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-382"><a href="#cb69-382" aria-hidden="true" tabindex="-1"></a><span class="in">```{r stan-compile, eval = FALSE}</span></span>
<span id="cb69-383"><a href="#cb69-383" aria-hidden="true" tabindex="-1"></a>mod5 <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(here<span class="sc">::</span><span class="fu">here</span>(mod_model_dir, model_name_ext), <span class="at">stanc_options =</span> <span class="fu">list</span>(<span class="st">"O1"</span>))</span>
<span id="cb69-384"><a href="#cb69-384" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-385"><a href="#cb69-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-386"><a href="#cb69-386" aria-hidden="true" tabindex="-1"></a>We used optimization for initial testing:</span>
<span id="cb69-387"><a href="#cb69-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-388"><a href="#cb69-388" aria-hidden="true" tabindex="-1"></a><span class="in">```{r stan-optimize, eval = FALSE}</span></span>
<span id="cb69-389"><a href="#cb69-389" aria-hidden="true" tabindex="-1"></a>fit_opt <span class="ot">&lt;-</span> mod5<span class="sc">$</span><span class="fu">optimize</span>(</span>
<span id="cb69-390"><a href="#cb69-390" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> datastruct,</span>
<span id="cb69-391"><a href="#cb69-391" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_dir =</span> mod_output_dir,</span>
<span id="cb69-392"><a href="#cb69-392" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_basename =</span> <span class="st">"mod5-opt"</span>,</span>
<span id="cb69-393"><a href="#cb69-393" aria-hidden="true" tabindex="-1"></a>  <span class="at">init =</span> init,</span>
<span id="cb69-394"><a href="#cb69-394" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter=</span><span class="dv">3000</span></span>
<span id="cb69-395"><a href="#cb69-395" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-396"><a href="#cb69-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-397"><a href="#cb69-397" aria-hidden="true" tabindex="-1"></a>fit_opt<span class="sc">$</span><span class="fu">print</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"S1Hat"</span>,<span class="st">"dlogkwHat"</span>,<span class="st">"dS1Hat"</span>,<span class="st">"beta"</span>,<span class="st">"S2Hat"</span>,<span class="st">"omega"</span>,<span class="st">"rho[1,2]"</span>,<span class="st">"sigma"</span>,<span class="st">"sdpi"</span>), <span class="at">max_rows=</span><span class="dv">13</span>)</span>
<span id="cb69-398"><a href="#cb69-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-399"><a href="#cb69-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-400"><a href="#cb69-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-401"><a href="#cb69-401" aria-hidden="true" tabindex="-1"></a>For local computations one can use cmdstanr:</span>
<span id="cb69-402"><a href="#cb69-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-403"><a href="#cb69-403" aria-hidden="true" tabindex="-1"></a><span class="in">```{r stan-sample, eval = FALSE}</span></span>
<span id="cb69-404"><a href="#cb69-404" aria-hidden="true" tabindex="-1"></a> fit <span class="ot">&lt;-</span> mod5<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb69-405"><a href="#cb69-405" aria-hidden="true" tabindex="-1"></a>   <span class="at">data =</span> datastruct,</span>
<span id="cb69-406"><a href="#cb69-406" aria-hidden="true" tabindex="-1"></a>   <span class="at">output_dir =</span> mod_output_dir,</span>
<span id="cb69-407"><a href="#cb69-407" aria-hidden="true" tabindex="-1"></a>   <span class="at">output_basename =</span> <span class="st">"mod5"</span>,</span>
<span id="cb69-408"><a href="#cb69-408" aria-hidden="true" tabindex="-1"></a>   <span class="at">init =</span> init,</span>
<span id="cb69-409"><a href="#cb69-409" aria-hidden="true" tabindex="-1"></a>   <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb69-410"><a href="#cb69-410" aria-hidden="true" tabindex="-1"></a>   <span class="at">iter_sampling =</span> <span class="dv">500</span>,</span>
<span id="cb69-411"><a href="#cb69-411" aria-hidden="true" tabindex="-1"></a>   <span class="at">chains =</span> <span class="dv">8</span>,</span>
<span id="cb69-412"><a href="#cb69-412" aria-hidden="true" tabindex="-1"></a>   <span class="at">parallel_chains =</span> <span class="dv">8</span>,</span>
<span id="cb69-413"><a href="#cb69-413" aria-hidden="true" tabindex="-1"></a>   <span class="at">refresh =</span> <span class="dv">100</span>,</span>
<span id="cb69-414"><a href="#cb69-414" aria-hidden="true" tabindex="-1"></a>   <span class="at">adapt_delta=</span><span class="fl">0.9</span></span>
<span id="cb69-415"><a href="#cb69-415" aria-hidden="true" tabindex="-1"></a> )</span>
<span id="cb69-416"><a href="#cb69-416" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-417"><a href="#cb69-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-418"><a href="#cb69-418" aria-hidden="true" tabindex="-1"></a>We performed out computations at the Academic Computer Center in Gdańsk, <span class="co">[</span><span class="ot">Tryton Cluster</span><span class="co">](https://docs.task.gda.pl/kdm/zasoby-sprzetowe/tryton/)</span>. In this case:</span>
<span id="cb69-419"><a href="#cb69-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-420"><a href="#cb69-420" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>we dumped the necessary data to .json format</span>
<span id="cb69-421"><a href="#cb69-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-422"><a href="#cb69-422" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dump-files, eval = FALSE}</span></span>
<span id="cb69-423"><a href="#cb69-423" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(datastruct, <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/standata.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-424"><a href="#cb69-424" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-1.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-425"><a href="#cb69-425" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-2.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-426"><a href="#cb69-426" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-3.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-427"><a href="#cb69-427" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-4.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-428"><a href="#cb69-428" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-5.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-429"><a href="#cb69-429" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-6.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-430"><a href="#cb69-430" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-7.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-431"><a href="#cb69-431" aria-hidden="true" tabindex="-1"></a><span class="fu">write_stan_json</span>(<span class="fu">init</span>(), <span class="fu">paste0</span>(mod_model_dir,<span class="st">"/init-8.json"</span>), <span class="at">always_decimal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb69-432"><a href="#cb69-432" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-433"><a href="#cb69-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-434"><a href="#cb69-434" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>we run the model using the batch file:</span>
<span id="cb69-435"><a href="#cb69-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-436"><a href="#cb69-436" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb69-437"><a href="#cb69-437" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;pre&gt; </span></span>
<span id="cb69-438"><a href="#cb69-438" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/pre&gt;</span></span>
<span id="cb69-439"><a href="#cb69-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-440"><a href="#cb69-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-441"><a href="#cb69-441" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>After calculations, we loaded the output files using cmdstanr. </span>
<span id="cb69-442"><a href="#cb69-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-443"><a href="#cb69-443" aria-hidden="true" tabindex="-1"></a><span class="in">```{r stan-load}</span></span>
<span id="cb69-444"><a href="#cb69-444" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> cmdstanr<span class="sc">::</span><span class="fu">as_cmdstan_fit</span>(<span class="fu">c</span>(</span>
<span id="cb69-445"><a href="#cb69-445" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-1.csv"</span>),</span>
<span id="cb69-446"><a href="#cb69-446" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-2.csv"</span>),</span>
<span id="cb69-447"><a href="#cb69-447" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-3.csv"</span>),</span>
<span id="cb69-448"><a href="#cb69-448" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-4.csv"</span>),</span>
<span id="cb69-449"><a href="#cb69-449" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-5.csv"</span>),</span>
<span id="cb69-450"><a href="#cb69-450" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-6.csv"</span>),</span>
<span id="cb69-451"><a href="#cb69-451" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-7.csv"</span>),</span>
<span id="cb69-452"><a href="#cb69-452" aria-hidden="true" tabindex="-1"></a>                                  <span class="fu">paste0</span>(mod_output_dir,<span class="st">"/"</span>,  model_name, <span class="st">"-8.csv"</span>)</span>
<span id="cb69-453"><a href="#cb69-453" aria-hidden="true" tabindex="-1"></a>                                ))</span>
<span id="cb69-454"><a href="#cb69-454" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-455"><a href="#cb69-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-456"><a href="#cb69-456" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>finally we checked the diagnostics of Monte Carlo inferences based on the Stan documentation described herein <span class="co">[</span><span class="ot">diagnose</span><span class="co">](https://mc-stan.org/docs/cmdstan-guide/diagnose.html)</span></span>
<span id="cb69-457"><a href="#cb69-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-458"><a href="#cb69-458" aria-hidden="true" tabindex="-1"></a><span class="in">```{r stan-diagnose, eval = FALSE}</span></span>
<span id="cb69-459"><a href="#cb69-459" aria-hidden="true" tabindex="-1"></a> <span class="co">#fit$cmdstan_diagnose()</span></span>
<span id="cb69-460"><a href="#cb69-460" aria-hidden="true" tabindex="-1"></a> <span class="fu">setwd</span>(mod_output_dir)</span>
<span id="cb69-461"><a href="#cb69-461" aria-hidden="true" tabindex="-1"></a> str <span class="ot">=</span> <span class="fu">paste0</span>(<span class="fu">cmdstan_path</span>(), <span class="st">'/bin/diagnose  mod5-*.csv'</span>)</span>
<span id="cb69-462"><a href="#cb69-462" aria-hidden="true" tabindex="-1"></a> <span class="fu">system</span>(str,<span class="at">intern=</span><span class="cn">TRUE</span>)</span>
<span id="cb69-463"><a href="#cb69-463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-464"><a href="#cb69-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-465"><a href="#cb69-465" aria-hidden="true" tabindex="-1"></a>The diagnostics are reasonable given model complexity. Output copied here to save time:</span>
<span id="cb69-466"><a href="#cb69-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-467"><a href="#cb69-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb69-468"><a href="#cb69-468" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;pre&gt;</span></span>
<span id="cb69-469"><a href="#cb69-469" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;/pre&gt;</span></span>
<span id="cb69-470"><a href="#cb69-470" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-471"><a href="#cb69-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-472"><a href="#cb69-472" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary of model parameters (table):</span></span>
<span id="cb69-473"><a href="#cb69-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-474"><a href="#cb69-474" aria-hidden="true" tabindex="-1"></a>The <span class="co">[</span><span class="ot">stansummary</span><span class="co">](https://mc-stan.org/docs/cmdstan-guide/stansummary.html)</span> function was used to report summary and diagnostic statistics over model parameters. </span>
<span id="cb69-475"><a href="#cb69-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-476"><a href="#cb69-476" aria-hidden="true" tabindex="-1"></a><span class="in">```{r summary}</span></span>
<span id="cb69-477"><a href="#cb69-477" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">$</span><span class="fu">print</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"S1Hat"</span>,<span class="st">"dlogkwHat"</span>,<span class="st">"dS1Hat"</span>, <span class="st">"beta"</span>,<span class="st">"S2Hat"</span>,<span class="st">"omega"</span>,<span class="st">"rho[1,2]"</span>,<span class="st">"sigma"</span>,<span class="st">"sdpi"</span>, <span class="st">"nu"</span>), <span class="at">max_rows=</span><span class="dv">15</span>)</span>
<span id="cb69-478"><a href="#cb69-478" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-479"><a href="#cb69-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-480"><a href="#cb69-480" aria-hidden="true" tabindex="-1"></a><span class="fu">## Trace plots</span></span>
<span id="cb69-481"><a href="#cb69-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-482"><a href="#cb69-482" aria-hidden="true" tabindex="-1"></a>Trace plots are time series plots of Markov chains. Here we show standard trace plots for several parameters</span>
<span id="cb69-483"><a href="#cb69-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-484"><a href="#cb69-484" aria-hidden="true" tabindex="-1"></a><span class="in">```{r trace-plots, include=TRUE}</span></span>
<span id="cb69-485"><a href="#cb69-485" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_trace</span>(fit<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"S1Hat"</span>,<span class="st">"beta"</span>,<span class="st">"S2Hat"</span>))) </span>
<span id="cb69-486"><a href="#cb69-486" aria-hidden="true" tabindex="-1"></a>bayesplot<span class="sc">::</span><span class="fu">mcmc_trace</span>(fit<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"omega"</span>,<span class="st">"rho[1,2]"</span>,<span class="st">"sigma"</span>,<span class="st">"sdpi"</span>))) </span>
<span id="cb69-487"><a href="#cb69-487" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-488"><a href="#cb69-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-489"><a href="#cb69-489" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary of model parameters (figures)</span></span>
<span id="cb69-490"><a href="#cb69-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-491"><a href="#cb69-491" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mcmc-intervals}</span></span>
<span id="cb69-492"><a href="#cb69-492" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(fit<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"logkwHat"</span>,<span class="st">"S1Hat"</span>,<span class="st">"beta"</span>,<span class="st">"S2Hat"</span>)))</span>
<span id="cb69-493"><a href="#cb69-493" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_intervals</span>(fit<span class="sc">$</span><span class="fu">draws</span>(<span class="fu">c</span>(<span class="st">"omega"</span>,<span class="st">"sigma"</span>,<span class="st">"sdpi"</span>)))</span>
<span id="cb69-494"><a href="#cb69-494" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb69-495"><a href="#cb69-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-496"><a href="#cb69-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-497"><a href="#cb69-497" aria-hidden="true" tabindex="-1"></a><span class="fu"># Session info</span></span>
<span id="cb69-498"><a href="#cb69-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-501"><a href="#cb69-501" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb69-502"><a href="#cb69-502" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb69-503"><a href="#cb69-503" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>